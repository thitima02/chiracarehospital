<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../../styles.css">
    <link rel="stylesheet" href="../../css/sidebar.css">
    <link rel="stylesheet" href="css/topbar.css">
    <link rel="stylesheet" href="../../frontend/vhvpage/css/menubar.css">
    <link rel="stylesheet" href="../../frontend/vhvpage/css/logo.css">
    <link rel="stylesheet" href="../../frontend/vhvpage/css/button.css">
    <link rel="stylesheet" href="../../frontend/vhvpage/css/result.css">
    <link rel="stylesheet" href="../../frontend/vhvpage/css/datatable.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Import icon -->
    <link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>
    <script src="../method/logout.js"></script>
    <!-- เชื่อมโยงไฟล์ JavaScript สำหรับจัดการการออกจากระบบ -->
    <script src="../method/user.js"></script>
    <!-- เชื่อมโยงไฟล์ JavaScript สำหรับการจัดการข้อมูลผู้ใช้ -->
    <script src="../method/loadSidebarScript.js"></script>
    <!-- เชื่อมโยงไฟล์ JavaScript สำหรับโหลดสคริปต์ sidebar -->
    <script src="../method/checkAuth.js"></script>
    <!-- เชื่อมโยงไฟล์ JavaScript สำหรับตรวจสอบการพิสูจน์ตัวตน (Authentication) -->
</head>

<body>


    <div id="sidebar-container"></div>

    <!-- Topbar will be loaded here -->
    <div id="topbar-container"></div>

    <!-- the resule of many patient -->
    <div>
        <div class="stats-container">
            <div class="box new-order">
                <i class='bx bx-user'></i>
                <div>
                    <h2>0</h2>
                    <p>จำนวนการกรอกข้อมูลการติดตามที่ยังไม่เสร็จสิ้น</p>
                </div>
            </div>
            <div class="box box2 visitors">
                <i class='bx bx-smile'></i>
                <div>
                    <h2>0</h2>
                    <p>ผู้ป่วยทั้งหมดที่ติดตามแล้ว</p>
                </div>
            </div>
            <div class="box box3 total-sales">
                <i class='bx bx-tired'></i>
                <div>
                    <h2>0</h2>
                    <p>ผู้ป่วยทั้งหมดที่ยังไม่ได้ติดตาม</p>
                </div>
            </div>
        </div>
    </div>

    <!-- the dropdrown  -->
    <div class="filter-container">
        <div class="filter-item search-bar">
            <h5>ค้นหารายชื่อ</h5>
            <input type="text" id="searchInput" placeholder="ค้นหาที่นี่..." class="search-input">
            <i class='bx bx-search search-icon'></i>
        </div>
        <div class="filter-item">
            <h5>วันที่เริ่มติดตาม</h5>
            <input type="date" class="date-filter">
        </div>
        <div class="filter-item">
            <h5>ครั้งที่ติดตาม</h5>
            <select class="dropdown-filter">
                <option value="ทั้งหมด">ทั้งหมด</option>
                <option value="">1</option>
                <option value="">2</option>
                <option value="">3</option>
                <!-- Add other options as needed -->
            </select>
            <i class='bx bx-chevron-down dropdown-icon'></i>
        </div>

        <div class="filter-item">
            <h5>สถานะการติดตาม</h5>
            <select class="dropdown-filter">
                <option value="ทั้งหมด">ทั้งหมด</option>
                <option value="">ยังไม่ได้ติดตาม</option>
                <option value="">กำลังติดตาม</option>
                <option value="">ติดตามแล้ว</option>
                <option value="">ติดตามล้มเหลว</option>
                <!-- Add other options as needed -->
            </select>
            <i class='bx bx-chevron-down dropdown-icon'></i>
        </div>


    </div>

    <!-- the datatable  -->
    <div class="table-container">
        <table class="patient-table">
            <thead>
                <tr>
                    <th>รายชื่อผู้ป่วย</th>
                    <th>วันที่เริ่มติดตาม</th>
                    <th>โรคประจำตัว</th>
                    <th>ที่อยู่</th>
                    <th>สถานะการติดตาม</th>
                    <th>ครั้งที่ติดตาม</th>
                    <th></th>
                </tr>
            </thead>

            <tbody id="patient-tbody"></tbody>

            </tbody>

        </table>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {

            // Fetch total patients count from PHP
            fetch("http://localhost/chiracarehospital/backend/sql/vhv/get_patient_address.php")
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Total Patients Data:", data); // Log data for debugging
                    const todayPatientsCount = document.querySelector('.new-order h2');
                    todayPatientsCount.textContent = data.total || 0;
                })
                .catch(error => console.error("Error fetching total patients count:", error));

            // Fetch patient address data
            fetch("../../backend/sql/vhv/get_patient_address.php")
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Patient Address Data:", data);
                    const tbody = document.getElementById("patient-tbody");

                    // Filter data to get only patients with status "กำลังติดตาม"
                    const filteredData = data.filter(patient => patient.monitor_status === "กำลังติดตาม");

                    // Check if there is any filtered data
                    if (filteredData.length > 0) {
                        filteredData.forEach(patient => {
                            const row = document.createElement("tr");

                            const imageUrl = patient.patient_image
                                ? `data:image/jpeg;base64,${patient.patient_image}`
                                : '../../assets/images/cat.jpg';

                            // Check if the monitor_status is "ติดตามแล้ว"
                            const actionButton = patient.monitor_status === "ติดตามแล้ว"
                                ? `<span style="color:#16bc19;">รายงานผลเรียบร้อยแล้ว</span>`
                                : `<a href="form.html?patient_id=${patient.patient_id}&full_name=${patient.full_name}&disease=${patient.disease_type}" class="formbutton" title="กรอกข้อมูลการติดตาม">
                                <i class='bx bxs-edit'></i> กรอกข้อมูลการติดตาม
                                 </a>`;

                            // Populate the row with patient data
                            row.innerHTML = `
                                <td style="text-align: left; padding-left: 40px">
                                    <img src='${imageUrl}' alt='patient image' style="width: 45px; height: 45px;"> ${patient.full_name}
                                </td>
                                <td id='startDate'>${patient.monitor_date}</td>
                                <td id='endDate'>${patient.disease_type}</td>
                                <td id='address' style="width:20%">${patient.number} หมู่ ${patient.moo || '-'} ซอย ${patient.soi || '-'} ตำบล/แขวง ${patient.tambon} อำเภอ/เขต ${patient.amphur} จังหวัด ${patient.province} เลขไปรษณีย์ ${patient.postal_code}</td>
                                <td id='timesFollowed'>${patient.monitor_status}</td>
                                <td id='timesFollowed'>${patient.monitor_round}</td>
                                <td>${actionButton}</td>
                            `;
                            tbody.appendChild(row);
                        });
                    } else {
                        tbody.innerHTML = "<tr><td colspan='6'>ไม่พบข้อมูลผู้ป่วยที่กำลังติดตาม</td></tr>";
                    }
                })
                .catch(error => console.error("Error fetching patient data:", error));

        });
    </script>

    <script>
        // Function for filter the name
        document.addEventListener("DOMContentLoaded", function () {
            // Get the search input field
            const searchInput = document.getElementById('searchInput');

            // Add event listener to the search input
            searchInput.addEventListener('keyup', function () {
                // Get the value of the search input and convert to lowercase
                let searchTerm = searchInput.value.toLowerCase();

                // Get all the rows of the table
                const rows = document.querySelectorAll("#patient-tbody tr");

                // Loop through the rows to find matches
                rows.forEach(row => {
                    // Find the cell that contains the patient's name
                    let nameCell = row.querySelector("td:first-child").innerText.toLowerCase();

                    // Check if the search term is found in the name
                    if (nameCell.includes(searchTerm)) {
                        row.style.display = ""; // Show row if there's a match
                    } else {
                        row.style.display = "none"; // Hide row if there's no match
                    }
                });
            });
        });
    </script>

    <script>
        // เรียกฟังก์ชัน checkAuth() เพื่อตรวจสอบ token
        checkAuth();

        // Load sidebar
        fetch('sidebar.html')
            // ใช้ fetch เพื่อดึงข้อมูล sidebar.html
            .then(response => response.text())
            // แปลงข้อมูลที่ได้รับเป็นข้อความ
            .then(data => {
                document.getElementById('sidebar-container').innerHTML = data;
                // นำข้อมูลที่ดึงมาแสดงใน sidebar-container
                loadSidebarScript();
                // เรียกฟังก์ชัน loadSidebarScript() เพื่อทำงานเพิ่มเติมกับ sidebar
            });

        // Load topbar and set the page title
        fetch('topbar.html')
            // ใช้ fetch เพื่อดึงข้อมูล topbar.html
            .then(response => response.text())
            // แปลงข้อมูลที่ได้รับเป็นข้อความ
            .then(data => {
                document.getElementById('topbar-container').innerHTML = data;
                // นำข้อมูลที่ดึงมาแสดงใน topbar-container
                document.getElementById('page-title').textContent = 'หน้าหลัก';
                // กำหนดชื่อเรื่องของหน้าเป็น 'หน้าหลัก'

                // Re-run user.js script after loading topbar
                const script = document.createElement('script');
                // สร้างแท็ก script ใหม่
                script.src = '../method/user.js';
                // กำหนดแหล่งที่มาของ script เป็น user.js
                document.body.appendChild(script);
                // เพิ่มแท็ก script ลงใน body ของเอกสารเพื่อทำการโหลดสคริปต์
            });
    </script>

</body>

</html>