<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">
    <title>The Main Page</title>
    <link rel="stylesheet" href="../../styles.css">
    <link rel="stylesheet" href="../../css/sidebar.css">
    <link rel="stylesheet" href="../../css/topbar.css">
    <link rel="stylesheet" href="../../frontend/opdpage/css/filltermenu.css">
    <link rel="stylesheet" href="../../frontend/opdpage/css/logo.css">
    <link rel="stylesheet" href="../../frontend/opdpage/css/button.css">
    <link rel="stylesheet" href="../../frontend/opdpage/css/result.css">
    <link rel="stylesheet" href="../../frontend/opdpage/css/datatable.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Import icon -->
    <link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>
    <script src="../method/logout.js"></script>
    <!-- เชื่อมโยงไฟล์ JavaScript สำหรับจัดการการออกจากระบบ -->
    <script src="../method/user.js"></script>
    <!-- เชื่อมโยงไฟล์ JavaScript สำหรับการจัดการข้อมูลผู้ใช้ -->
    <script src="../method/loadSidebarScript.js"></script>
    <!-- เชื่อมโยงไฟล์ JavaScript สำหรับโหลดสคริปต์ sidebar -->
    <script src="../method/checkAuth.js"></script>
    <!-- เชื่อมโยงไฟล์ JavaScript สำหรับตรวจสอบการพิสูจน์ตัวตน (Authentication) -->

</head>

<body>

    <!-- Sidebar will be loaded here -->
    <div id="sidebar-container"></div>

    <!-- Topbar will be loaded here -->
    <div id="topbar-container"></div>

    <!-- the result of many patients -->
    <container>
        <div class="stats-container">
            <div class="box new">
                <i class='bx bx-user'></i>
                <div>
                    <h2 id="totalAppointments">0 คน</h2>
                    <p>ผู้ป่วยทั้งหมดที่ต้องเข้ารักษาการรักษาวันนี้</p>
                </div>
            </div>
            <!-- จำนวนที่รักษาและไม่รักษา -->
            <div class="box box2 success">
                <i class='bx bx-smile'></i>
                <div>
                    <h2 id="totalTreated">0 คน</h2>
                    <p>ผู้ป่วยทั้งหมดที่รักษาเสร็จสิ้น</p>
                </div>
            </div>
            <div class="box box3 unsuccess">
                <i class='bx bx-tired'></i>
                <div>
                    <h2 id="totalUntreated">0 คน</h2>
                    <p>ผู้ป่วยทั้งหมดที่ยังไม่ได้รับการรักษา</p>
                </div>
            </div>
            <!-- จำนวนที่รักษาและไม่รักษา -->
        </div>
    </container>

    <script>
        // appointment_date 
        document.addEventListener("DOMContentLoaded", function () {
            fetch("http://localhost/chiracarehospital/backend/sql/opd/fetch_appointments.php")
                .then(response => response.json())
                .then(data => {
                    document.getElementById("totalAppointments").textContent = `${data.totalAppointments} คน`;
                })
                .catch(error => console.error("Error fetching data:", error));
        });
        // treatment_status
        document.addEventListener("DOMContentLoaded", function () {
            fetch("http://localhost/chiracarehospital/backend/sql/opd/fetch_patient_counts.php")
                .then(response => response.json())
                .then(data => {
                    document.getElementById("totalTreated").textContent = data.totalTreated + " คน";
                    document.getElementById("totalUntreated").textContent = data.totalUntreated + " คน";
                })
                .catch(error => console.error("Error fetching patient counts:", error));
        });
    </script>

    <!-- Filters -->
    <section class="filter-section" style="justify-content: center;">
        <div class="filter-container">
            <div class="filter-item search-bar">
                <h5>ค้นหารายชื่อ</h5>
                <input type="text" placeholder="ค้นหาที่นี่..." class="search-input" id="searchPatientInput">
                <i class='bx bx-search search-icon'></i>
            </div>
            <div class="filter-item">
                <h5>วันที่นัดหมาย</h5>
                <input type="date" class="date-filter" id="appointmentDateFilter">
            </div>
            <div class="filter-item">
                <h5>วันที่นัดครั้งถัดไป</h5>
                <input type="date" class="date-filter" id="treatmentDateFilter">
            </div>
            <div class="filter-item">
                <h5>ครั้งที่รักษา</h5>
                <select class="dropdown-filter" id="treatmentCountFilter">
                    <option value="ทั้งหมด">ทั้งหมด</option>
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <!-- Add other options as needed -->
                </select>
            </div>
            <div class="filter-item">
                <h5>สถานะการรักษา</h5>
                <select class="dropdown-filter" id="treatmentStatusFilter">
                    <option value="ทั้งหมด">ทั้งหมด</option>
                    <option value="ยังไม่ได้รักษา">ยังไม่ได้รักษา</option>
                    <option value="นัดติดตามต่อเนื่อง">นัดติดตามต่อเนื่อง</option>
                    <option value="รักษาเสร็จสิ้น">รักษาเสร็จสิ้น</option>
                </select>
            </div>
        </div>
    </section>

    <script>
        // Filter logic
        document.addEventListener('DOMContentLoaded', function () {
            const searchInput = document.getElementById('searchPatientInput');
            const appointmentDateFilter = document.getElementById('appointmentDateFilter');
            const treatmentCountFilter = document.getElementById('treatmentCountFilter');
            const treatmentStatusFilter = document.getElementById('treatmentStatusFilter');
            const treatmentDateFilter = document.getElementById('treatmentDateFilter');
            const patientTableBody = document.querySelector('.patient-table tbody');

            // Filter Function
            function filterData() {
                const searchTerm = searchInput.value.toLowerCase();
                const appointmentDate = appointmentDateFilter.value;
                const treatmentCount = treatmentCountFilter.value;
                const treatmentStatus = treatmentStatusFilter.value;
                const treatmentDate = treatmentDateFilter.value;

                const rows = patientTableBody.getElementsByTagName('tr');

                for (let i = 0; i < rows.length; i++) {
                    const name = rows[i].getElementsByTagName('td')[0].textContent.toLowerCase();
                    const appointmentDateValue = rows[i].getElementsByTagName('td')[1].textContent;
                    const nextAppointmentDateValue = rows[i].getElementsByTagName('td')[3].textContent;
                    const treatmentCountValue = rows[i].getElementsByTagName('td')[4].textContent;
                    const treatmentStatusValue = rows[i].getElementsByTagName('td')[6].textContent;

                    let isVisible = true;

                    if (searchTerm && !name.includes(searchTerm)) {
                        isVisible = false;
                    }
                    if (appointmentDate && appointmentDateValue !== appointmentDate) {
                        isVisible = false;
                    }
                    if (treatmentCount !== 'ทั้งหมด' && treatmentCountValue !== treatmentCount) {
                        isVisible = false;
                    }
                    if (treatmentStatus !== 'ทั้งหมด' && treatmentStatusValue !== treatmentStatus) {
                        isVisible = false;
                    }
                    if (treatmentDate && nextAppointmentDateValue !== treatmentDate) {
                        isVisible = false;
                    }

                    rows[i].style.display = isVisible ? '' : 'none';
                }
            }

            // Attach events to filter fields
            searchInput.addEventListener('input', filterData);
            appointmentDateFilter.addEventListener('change', filterData);
            treatmentCountFilter.addEventListener('change', filterData);
            treatmentStatusFilter.addEventListener('change', filterData);
            treatmentDateFilter.addEventListener('change', filterData);
        });
    </script>

    <!-- the datatable  -->
    <div class="table-container">
        <table class="patient-table">
            <thead>
                <tr>
                    <th style="text-align: left; padding-left: 100px">รายชื่อผู้ป่วย</th>
                    <th>โรคประจำตัว</th>
                    <th>วันนัดหมาย</th>
                    <th>วันที่เข้ารักษา</th>
                    <th>ครั้งที่รักษา</th>
                    <th>สถานะการติดตาม</th>
                    <th>สถานะการรักษา</th>
                    <th>จัดการ</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be inserted here by JavaScript -->
            </tbody>
        </table>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            fetch("http://localhost/chiracarehospital/backend/sql/opd/fetch_treatments.php")
                .then(response => response.json())
                .then(data => {
                    const tbody = document.querySelector(".patient-table tbody");
                    tbody.innerHTML = ""; // Clear existing rows

                    // กรองข้อมูลเพื่อแสดงเฉพาะคนที่สถานะการติดตามเป็น "ติดตามแล้ว"
                    const filteredData = data.filter(patient => patient.follow_up_status === "ติดตามแล้ว");

                    // วนลูปข้อมูลที่กรองแล้วเพื่อแสดงในตาราง patient_name
                    filteredData.forEach(patient => {
                        const followUpStatusClass = getStatusClass(patient.follow_up_status);
                        const treatmentStatusClass = getStatusClass(patient.treatment_status);

                        const imageUrl = patient.patient_image
                            ? `data:image/jpeg;base64,${patient.patient_image}`
                            : '../../assets/images/cat.jpg';

                        const row = document.createElement("tr");
                        const isTreated = patient.treatment_status === "รักษาเสร็จสิ้น";
                        row.innerHTML = `
    <td style="text-align: left; padding-left: 40px">
        <img src='${imageUrl}' alt='patient image' style="width: 45px; height: 45px; border-radius: 50%; margin-right: 10px;">
        ${patient.patient_name || 'ไม่มีข้อมูล'}
    </td>
    <td>${patient.disease_type || 'ไม่ทราบ'}</td>
    <td>${patient.appointment_date || 'ไม่มี'}</td>
    <td>${patient.treatment_date || 'ไม่มี'}</td>
    <td>${patient.treatment_round || 'ไม่มีข้อมูล'}</td>
    <td><span class="status ${followUpStatusClass}">${patient.follow_up_status || 'ไม่มีข้อมูล'}</span></td>
    <td><span class="status ${treatmentStatusClass}">${patient.treatment_status || 'ไม่มีข้อมูล'}</span></td>
    <td>
        <div class="Actionbutton" data-patient-id="${patient.patient_id}" ${isTreated ? 'disabled style="opacity: 0.5;"' : ''}>
            <button class="action-btn" title="คลิกเพื่อเพิ่มนัด" 
        onclick="window.location.href='addappointment.html?patient_id=${encodeURIComponent(patient.patient_id)}&name=${encodeURIComponent(patient.patient_name)}&disease=${encodeURIComponent(patient.disease_type)}'">
    <i class='bx bx-file'></i>
</button>
            <button class="action-btn" title="คลิกเพื่อยืนยัน" onclick="confirmMakeDone(${patient.patient_id})">
                                <i class='bx bx-check'></i>
                            </button>
        </div>
    </td>
`;
                        tbody.appendChild(row);
                    });
                })
                .catch(error => console.error("Error fetching data:", error));
        });

        // action add 
        function confirmAction(patientId) {
            console.log(patientId); // ตรวจสอบว่ามี patientId หรือไม่
            fetch(`http://localhost:8080/chiracarehospital/backend/sql/opd/get_patient_data.php?id=${patientId}`)
                .then(response => response.json())
                .then(patient => {
                    const name = encodeURIComponent(patient.patient_name);
                    const disease = encodeURIComponent(patient.disease);
                    window.location.href = `test.html?name=${name}&disease=${disease}&id=${patientId}`; // ส่ง patient_id ไปด้วย
                })
                .catch(error => {
                    console.error("Error fetching patient data:", error);
                    alert("เกิดข้อผิดพลาดในการดึงข้อมูลผู้ป่วย");
                });
        }
        // Status color
        function getStatusClass(status) {
            switch (status) {
                case 'ยังไม่ได้ติดตาม':
                    return 'other';
                case 'กำลังติดตาม':
                    return 'other';
                case 'ติดตามแล้ว':
                    return 'other';
                case 'ติดตามล้มเหลว':
                    return 'other';
                case 'ยังไม่ได้รักษา':
                    return 'unsucess';
                case 'นัดติดตามต่อเนื่อง':
                    return 'continue';
                case 'รักษาเสร็จสิ้น':
                    return 'sucess';
            }
        }

    </script>

    <script>
        function confirmMakeDone(patientId) {
            // แสดงกล่องยืนยัน
            const confirmation = confirm("คุณต้องการยืนยันสถานะการรักษาว่า 'รักษาเสร็จสิ้น' หรือไม่?");
            if (confirmation) {
                // ตรวจสอบว่า patientId ถูกส่งมา
                console.log(patientId); // พิมพ์ค่า patientId เพื่อดูว่ามีค่าหรือไม่
                const currentTime = new Date().toISOString(); // เก็บเวลาปัจจุบัน
                const incrementRound = true; // ตั้งค่าให้เพิ่มรอบการรักษา
                updateTreatmentStatus(patientId, currentTime, incrementRound); // ส่งเวลาและข้อมูล incrementRound ไปด้วย
            } else {
                console.log("Cancelled");
            }
        }

        function updateTreatmentStatus(patientId, confirmationTime, incrementRound) {
            if (!patientId) {
                alert("ไม่พบ patient_id");
                return;
            }

            const xhr = new XMLHttpRequest();
            xhr.open("POST", "http://localhost/chiracarehospital/backend/sql/opd/update_treatment_status.php", true);
            xhr.setRequestHeader("Content-Type", "application/json");

            const params = JSON.stringify({
                patient_id: patientId,
                confirmed_at: confirmationTime,
                increment_round: incrementRound // ส่งข้อมูลเพิ่มรอบการรักษา
            });

            xhr.onreadystatechange = function () {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            if (response.status === "success") {
                                alert(response.message);
                                // รีเฟรชหน้าเว็บเมื่อสถานะการรักษาอัปเดตสำเร็จ
                                window.location.reload();
                            } else {
                                alert(response.message);
                            }
                        } catch (error) {
                            alert("เกิดข้อผิดพลาดในการประมวลผลข้อมูล: " + error.message);
                        }
                    } else {
                        alert("เกิดข้อผิดพลาดในการเชื่อมต่อกับเซิร์ฟเวอร์: " + xhr.status);
                    }
                }
            };

            xhr.send(params);
        }
    </script>

    <script>
        // เรียกฟังก์ชัน checkAuth() เพื่อตรวจสอบ token
        checkAuth();

        // Load sidebar
        fetch('sidebar.html')
            // ใช้ fetch เพื่อดึงข้อมูล sidebar.html
            .then(response => response.text())
            // แปลงข้อมูลที่ได้รับเป็นข้อความ
            .then(data => {
                document.getElementById('sidebar-container').innerHTML = data;
                // นำข้อมูลที่ดึงมาแสดงใน sidebar-container
                loadSidebarScript();
                // เรียกฟังก์ชัน loadSidebarScript() เพื่อทำงานเพิ่มเติมกับ sidebar
            });

        // Load topbar and set the page title
        fetch('topbar.html')
            // ใช้ fetch เพื่อดึงข้อมูล topbar.html
            .then(response => response.text())
            // แปลงข้อมูลที่ได้รับเป็นข้อความ
            .then(data => {
                document.getElementById('topbar-container').innerHTML = data;
                // นำข้อมูลที่ดึงมาแสดงใน topbar-container
                document.getElementById('page-title').textContent = 'หน้าหลัก';
                // กำหนดชื่อเรื่องของหน้าเป็น 'หน้าหลัก'

                // Re-run user.js script after loading topbar
                const script = document.createElement('script');
                // สร้างแท็ก script ใหม่
                script.src = '../method/user.js';
                // กำหนดแหล่งที่มาของ script เป็น user.js
                document.body.appendChild(script);
                // เพิ่มแท็ก script ลงใน body ของเอกสารเพื่อทำการโหลดสคริปต์
            });
    </script>

</body>

</html>