<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Main Page</title>
    <link rel="stylesheet" href="../../styles.css">
    <link rel="stylesheet" href="../../css/sidebar.css">
    <link rel="stylesheet" href="../../css/topbar.css">
    <link rel="stylesheet" href="../../frontend/opdpage/css/filltermenu.css">
    <link rel="stylesheet" href="../../frontend/opdpage/css/logo.css">
    <link rel="stylesheet" href="../../frontend/opdpage/css/button.css">
    <link rel="stylesheet" href="../../frontend/opdpage/css/result.css">
    <link rel="stylesheet" href="../../frontend/opdpage/css/datatable.css">
    <!-- Import icon -->
    <link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>
    <script src="../method/logout.js"></script>
    <!-- เชื่อมโยงไฟล์ JavaScript สำหรับจัดการการออกจากระบบ -->
    <script src="../method/user.js"></script>
    <!-- เชื่อมโยงไฟล์ JavaScript สำหรับการจัดการข้อมูลผู้ใช้ -->
    <script src="../method/loadSidebarScript.js"></script>
    <!-- เชื่อมโยงไฟล์ JavaScript สำหรับโหลดสคริปต์ sidebar -->
    <script src="../method/checkAuth.js"></script>
    <!-- เชื่อมโยงไฟล์ JavaScript สำหรับตรวจสอบการพิสูจน์ตัวตน (Authentication) -->

</head>

<body>

    <!-- Sidebar will be loaded here -->
    <div id="sidebar-container"></div>

    <!-- Topbar will be loaded here -->
    <div id="topbar-container"></div>

    <!-- the result of many patients -->
    <container>
        <div class="stats-container">
            <div class="box new">
            <img style ="width: 40px; height: 40px; border-radius: 50%;" src="../../assets/images/cat.jpg" alt="avatar">

                <div style="display: flex;">
                    <h2 id="totalAppointments">สมหมาย มีสุข</h2>
                    <p>สถานะ</p>
                    <p>เขตที่รับผิดชอบ</p>
                    <p>เบอร์โทรศัพท์</p>
                </div>
            </div>
        </div>
    </container>

    <!-- the datatable  -->
    <div class="table-container">
        <table class="patient-table">
            <thead>
                <tr>
                    <th>รายชื่อผู้ป่วย</th>
                    <th>รหัสไอดี</th>
                    <th>ที่อยู่</th>
                    <th>สถานะการรักษา</th>
                    <th>สถานะการติดตาม</th>
                    <th>จัดการ</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be inserted here by JavaScript -->
            </tbody>
        </table>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            // เรียกข้อมูลจาก API เมื่อหน้าเว็บโหลดเสร็จ
            $.getJSON('http://localhost/chiracarehospital/backend/sql/users/getAlluser.php', function (response) {
                if (response.status === 'success') {
                    var staffs = response.data;
                    var rows = '';

                    // วนลูปข้อมูลผู้ใช้เพื่อแสดงในตาราง
                    staffs.forEach(function (staff) {
                        // กรองเฉพาะผู้ที่มีสถานะเป็น 'อาสาสมัครสาธารณะสุข' หรือ 'เสนารักษ์'
                        if (staff.department === 'อาสาสมัครสาธารณสุข' || staff.department === 'เสนารักษ์') {
                            rows += '<tr>';
                            rows += '<td><img src="../../assets/images/cat.jpg" alt="avatar"> ' + staff.full_name + '</td>';
                            rows += '<td>' + staff.department + '</td>';
                            rows += '<td>' + staff.responsibility_area + '</td>';
                            rows += '<td>' + (staff.id_card ? staff.id_card : '-') + '</td>';
                            rows += '<td>' + (staff.id_card_number ? staff.id_card_number : '-') + '</td>';
                            rows += '<td>' + staff.phone_number + '</td>';
                            rows += '<td>';
                            rows += '<button class="action-btn" title="แก้ไขข้อมูล" onclick="editStaff(\'' + staff.id + '\')"><i class="bx bxs-edit"></i></button>';
                            rows += '<button class="action-btn" title="ดูเพิ่มเติม" onclick="moreStaff(\'' + staff.id + '\')"><i class="bx bx-right-arrow-alt"></i></button>';
                            rows += '<button class="action-btn" title="ลบข้อมูล" onclick="deleteStaff(\'' + staff.id + '\')"><i class="bx bx-trash"></i></button>';
                            rows += '</td>';
                            rows += '</tr>';
                        }
                    });

                    // แทรกข้อมูลในตาราง
                    $('#patient-info-body').html(rows);
                } else {
                    alert(response.message);
                }
            });
        });


        // ฟังก์ชันแก้ไขข้อมูล
        function editStaff(id) {
            // กำหนดให้ฟังก์ชันทำการแก้ไขข้อมูลตาม ID
            window.location.href = 'editaddstaff.html?id=' + id;
        }

        function moreStaff(id) {
            window.location.href = 'morestaff.html?id=' + id;
        }

        // ฟังก์ชันลบข้อมูล
        function deleteStaff(id) {
            if (confirm('คุณแน่ใจว่าต้องการลบข้อมูลนี้?')) {
                // ส่งคำขอลบไปยัง API
                $.ajax({
                    url: 'http://localhost/chiracarehospital/backend/sql/staff_information/delete_staff.php',
                    method: 'POST',
                    data: { id: id },
                    success: function (response) {
                        if (response.status === 'success') {
                            // รีโหลดหน้าเว็บหลังจากลบสำเร็จ
                            location.reload();
                        } else {
                            alert(response.message);
                        }
                    }
                });
            }
        }
    </script>

    <script>
        // เรียกฟังก์ชัน checkAuth() เพื่อตรวจสอบ token
        checkAuth();

        // Load sidebar
        fetch('sidebar.html')
            // ใช้ fetch เพื่อดึงข้อมูล sidebar.html
            .then(response => response.text())
            // แปลงข้อมูลที่ได้รับเป็นข้อความ
            .then(data => {
                document.getElementById('sidebar-container').innerHTML = data;
                // นำข้อมูลที่ดึงมาแสดงใน sidebar-container
                loadSidebarScript();
                // เรียกฟังก์ชัน loadSidebarScript() เพื่อทำงานเพิ่มเติมกับ sidebar
            });

        // Load topbar and set the page title
        fetch('topbar.html')
            // ใช้ fetch เพื่อดึงข้อมูล topbar.html
            .then(response => response.text())
            // แปลงข้อมูลที่ได้รับเป็นข้อความ
            .then(data => {
                document.getElementById('topbar-container').innerHTML = data;
                // นำข้อมูลที่ดึงมาแสดงใน topbar-container
                document.getElementById('page-title').textContent = 'หน้าหลัก';
                // กำหนดชื่อเรื่องของหน้าเป็น 'หน้าหลัก'

                // Re-run user.js script after loading topbar
                const script = document.createElement('script');
                // สร้างแท็ก script ใหม่
                script.src = '../method/user.js';
                // กำหนดแหล่งที่มาของ script เป็น user.js
                document.body.appendChild(script);
                // เพิ่มแท็ก script ลงใน body ของเอกสารเพื่อทำการโหลดสคริปต์
            });
    </script>

</body>

</html>