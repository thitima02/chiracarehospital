<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>โรงพยาบาลค่ายจิรประวัติ</title>
  <link rel="stylesheet" href="../../css/statustracking.css">
  <link rel="stylesheet" href="../../css/filltermenu.css">
  <link rel="stylesheet" href="../../styles.css">
  <link rel="stylesheet" href="../../css/sidebar.css">
  <link rel="stylesheet" href="../../css/topbar.css">
  <link rel="stylesheet" href="../../css/logo.css">
  <!-- Import icon -->
  <link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Titillium+Web:wght@300&display=swap">
  <link href='https://unpkg.com/boxicons@2.1.1/css/boxicons.min.css' rel='stylesheet'>

  <!-- นำเข้า jsPDF และฟอนต์ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.16/jspdf.plugin.autotable.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="../method/logout.js"></script>
  <script src="../method/user.js"></script>
  <script src="../method/loadSidebarScript.js"></script>
  <script src="../method/checkAuth.js"></script>
</head>

<body style="background-color:#edeff1;">
  <div id="sidebar-container"></div>
  <div id="topbar-container"></div>

  <div class="statustracking-container">
    <!-- Filters -->
    <section class="filter-section" style="justify-content: center;">
      <div class="filter-container">
        <div class="filter-item search-bar">
          <h5>ค้นหารายชื่อ</h5>
          <input type="text" placeholder="ค้นหาที่นี่..." class="search-input" id="searchPatientInput"
            oninput="filterData()">
          <i class='bx bx-search search-icon'></i>
        </div>
        <div class="filter-item">
          <h5>โรคประจำตัว</h5>
          <select class="dropdown-filter" id="treatmentCountFilter" onchange="filterData()">
            <option value="">ทั้งหมด</option>
            <option value="โรคความดันโลหิตสูง">โรคความดันโลหิตสูง</option>
            <option value="โรคอ้วน">โรคอ้วน</option>
            <option value="ไขมันในเลือดสูง">ไขมันในเลือดสูง</option>
            <option value="โรคเบาหวาน">โรคเบาหวาน</option>
            <option value="CVD Risk">CVD Risk</option>
            <option value="โรคไต">โรคไต</option>
          </select>
          <i class='bx bx-chevron-down down-icon'></i>
        </div>
        <div class="filter-item">
          <h5>วันที่เริ่มติดตาม</h5>
          <input type="date" class="date-filter" id="appointmentDateFilter" onchange="filterData()">
        </div>
        <div class="filter-item">
          <h5>กำหนดส่งงาน</h5>
          <input type="date" class="date-filter" id="DeadlineDateFilter" onchange="filterData()">
        </div>
        <div class="filter-item">
          <h5>สถานะเข้ารับการรักษา</h5>
          <select class="dropdown-filter" id="treatmentStatusFilter" onchange="filterData()">
            <option value="ทั้งหมด">ทั้งหมด</option>
            <option value="มาตามนัด">มาตามนัด</option>
            <option value="ไม่มาตามนัด">ไม่มาตามนัด</option>
          </select>
          <i class='bx bx-chevron-down down-icon'></i>
        </div>

        <div class="filter-item">
          <h5>สถานะการติดตาม</h5>
          <select class="dropdown-filter" id="followUpStatusFilter" onchange="filterData()">
            <option value="ทั้งหมด">ทั้งหมด</option>
            <option value="ยังไม่ได้ติดตาม">ยังไม่ได้ติดตาม</option>
            <option value="ติดตามแล้ว">ติดตามแล้ว</option>
            <option value="กำลังติดตาม">กำลังติดตาม</option>
            <option value="ติดตามล้มเหลว">ติดตามล้มเหลว</option>
          </select>
          <i class='bx bx-chevron-down down-icon'></i>
        </div>

        <div id="download-pdf-button" title='ดาวน์โหลดPDF' style="height: 25px; width: 30px;">
          <button id="download-pdf-button">
            <i class='bx bxs-file-pdf'></i>
          </button>
        </div>
      </div>
    </section>

    <select id="sortOption" onchange="sortData()">
      <option value="name">เรียงตามชื่อ</option>
      <option value="status">เรียงตามสถานะการติดตาม</option>
      <option value="latest">เรียงตามวันที่ติดตามล่าสุด</option>
    </select>

    <!-- Overlay สำหรับป๊อปอัป -->
    <div id="popup-overlay" style="display: none;"></div>

    <!-- Modal Popup -->
    <div id="popup-modal" style="display: none;">
      <span id="close-popup-icon" class="close-icon">&times;</span>
      <h2>เลือกผู้ป่วยที่ต้องการดาวน์โหลดข้อมูล</h2>

      <!-- ฟิลเตอร์ -->
      <div class="filter-container"
        style="margin-bottom: 15px; margin-bottom: 15px; display: flex; gap: 15px; flex-wrap: wrap;">
        <div>
          <label for="filter-patient-name">ชื่อผู้ป่วย:</label>
          <input type="text" id="filter-patient-name" placeholder="กรอกชื่อผู้ป่วย" />
        </div>
        <div>
          <label for="filter-disease-type">โรคประจำตัว:</label>
          <select id="filter-disease-type">
            <option value="">ทั้งหมด</option>
            <option value="โรคความดันโลหิตสูง">โรคความดันโลหิตสูง</option>
            <option value="โรคอ้วน">โรคอ้วน</option>
            <option value="ไขมันในเลือดสูง">ไขมันในเลือดสูง</option>
            <option value="โรคเบาหวาน">โรคเบาหวาน</option>
            <option value="CVD Risk">CVD Risk</option>
            <option value="โรคไต">โรคไต</option>
          </select>
        </div>
        <div>
          <label for="filter-patient-type">ประเภทผู้ป่วย:</label>
          <select id="filter-patient-type">
            <option value="">ทั้งหมด</option>
            <option value="ประชาชน">ประชาชน</option>
            <option value="กำลังพล">กำลังพล</option>
            <option value="ครอบครัว">ครอบครัว</option>
          </select>
        </div>
        <div>
          <label for="filter-monitor-start-date">วันที่เริ่มติดตาม:</label>
          <input type="date" id="filter-monitor-start-date" />
        </div>
        <div>
          <label for="filter-monitor-deadline">กำหนดส่งงาน:</label>
          <input type="date" id="filter-monitor-deadline" />
        </div>

        <div>
          <label for="filter-user-name">ผู้รับผิดชอบ:</label>
          <input type="text" id="filter-user-name" placeholder="กรอกชื่อผู้รับผิดชอบ" />
        </div>
      </div>

      <!-- ตาราง -->
      <table id="popup-table" border="1" style="width: 100%; text-align: left;">
        <thead>
          <tr>
            <th style="width: 60px;">
              <input type="checkbox" id="select-all-checkbox" />
            </th>
            <th>ชื่อผู้ป่วย</th>
            <th>ประเภทโรค</th>
            <th>ประเภทผู้ป่วย</th>
            <th>วันที่เริ่มติดตาม</th>
            <th>กำหนดส่งงาน</th>
            <th>ชื่อผู้รับผิดชอบ</th>
          </tr>
        </thead>
        <tbody>
          <!-- ตารางข้อมูลผู้ป่วยจะแสดงในนี้ -->
        </tbody>
      </table>
      <div class="button_popup" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px;">
        <button id="generate-pdf-button">สร้าง PDF</button>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <script>
      document.getElementById('select-all-checkbox').addEventListener('change', function () {
        const checkboxes = document.querySelectorAll('.popup-patient-checkbox');
        checkboxes.forEach(checkbox => {
          checkbox.checked = this.checked;
        });
      });
    </script>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const downloadPdfButton = document.getElementById('download-pdf-button');
        const popupModal = document.getElementById('popup-modal');
        const popupOverlay = document.getElementById('popup-overlay');
        const popupTableBody = document.querySelector('#popup-table tbody');
        const generatePdfButton = document.getElementById('generate-pdf-button');
        const closePopupIcon = document.getElementById('close-popup-icon');

        const patientNameFilter = document.getElementById('filter-patient-name');
        const diseaseFilter = document.getElementById('filter-disease-type');
        const patientTypeFilter = document.getElementById('filter-patient-type');
        const monitorStartDateFilter = document.getElementById('filter-monitor-start-date');
        const monitorDeadlineFilter = document.getElementById('filter-monitor-deadline');
        const responsibleNameFilter = document.getElementById('filter-user-name'); // ฟิลเตอร์ชื่อผู้รับผิดชอบ  

        let patientData = []; // เก็บข้อมูลผู้ป่วยทั้งหมด

        // ฟังก์ชันเปิดป๊อปอัปและดึงข้อมูลจาก API
        async function openPopup() {
          popupOverlay.style.display = 'block';
          popupModal.style.display = 'block';
          popupTableBody.innerHTML = '';

          try {
            const response = await fetch('/chiracarehospital/backend/sql/monitoring/pdf.php');
            const data = await response.json();

            if (data.error) {
              alert('ไม่สามารถดึงข้อมูลผู้ป่วยได้');
              closePopup();
              return;
            }

            patientData = data;
            if (!patientData || patientData.length === 0) {
              alert('ไม่มีข้อมูลผู้ป่วย');
              closePopup();
              return;
            }

            displayTable(patientData);
          } catch (error) {
            console.error('เกิดข้อผิดพลาดในการดึงข้อมูล:', error);
            alert('ไม่สามารถดึงข้อมูลผู้ป่วยได้');
            closePopup();
          }
        }

        // ฟังก์ชันปิดป๊อปอัป
        function closePopup() {
          popupModal.style.display = 'none';
          popupOverlay.style.display = 'none';
        }

        // ฟังก์ชันแสดงข้อมูลในตาราง
        function displayTable(data) {
          popupTableBody.innerHTML = '';

          if (data.length === 0) {
            const emptyRow = document.createElement('tr');
            emptyRow.innerHTML = `<td colspan="7" style="text-align: center; font-style: italic;">ไม่มีข้อมูลในตาราง</td>`;
            popupTableBody.appendChild(emptyRow);
            return;
          }

          data.forEach(patient => {
            const { full_name, disease_type, patient_type, monitor_date, monitor_deadline, responsible_name } = patient;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="width: 60px;"><input type="checkbox" class="popup-patient-checkbox" /></td>
                <td>${full_name || 'ไม่ระบุชื่อ'}</td>
                <td>${disease_type || 'ไม่ระบุโรค'}</td>
                <td>${patient_type || 'ไม่ระบุประเภทผู้ป่วย'}</td>
                <td>${monitor_date || 'ไม่ระบุวันที่เริ่มติดตาม'}</td>
                <td>${monitor_deadline || 'ไม่ระบุกำหนดส่งงาน'}</td>
                <td>${responsible_name || 'ไม่ระบุชื่อผู้รับผิดชอบ'}</td>
              `;
            popupTableBody.appendChild(tr);
          });
        }

        // ฟังก์ชันกรองข้อมูลในตาราง
        function filterTable() {
          const nameValue = patientNameFilter.value.toLowerCase();
          const diseaseValue = diseaseFilter.value.toLowerCase();
          const patientTypeValue = patientTypeFilter.value.toLowerCase();
          const startDateValue = monitorStartDateFilter.value;
          const deadlineValue = monitorDeadlineFilter.value;
          const responsibleNameValue = responsibleNameFilter.value.toLowerCase();

          // กรองข้อมูลตามค่าฟิลเตอร์ทั้งหมด
          const filteredData = patientData.filter(patient => {
            const matchesName = !nameValue || (patient.full_name || '').toLowerCase().includes(nameValue);
            const matchesDisease = !diseaseValue || (patient.disease_type || '').toLowerCase().includes(diseaseValue);
            const matchesPatientType = !patientTypeValue || (patient.patient_type || '').toLowerCase().includes(patientTypeValue);
            const matchesStartDate = !startDateValue || (patient.monitor_date || '').startsWith(startDateValue);
            const matchesDeadline = !deadlineValue || (patient.monitor_deadline || '').startsWith(deadlineValue);
            const matchesResponsible = !responsibleNameValue || (patient.responsible_name || '').toLowerCase().includes(responsibleNameValue); // ตรวจสอบชื่อผู้รับผิดชอบ

            return matchesName && matchesDisease && matchesPatientType && matchesStartDate && matchesDeadline && matchesResponsible;
          });

          displayTable(filteredData);
        }
        // ฟังก์ชันสร้าง PDF
        function generatePdf() {
          const { jsPDF } = window.jspdf;

          // สร้างเอกสาร PDF ใหม่
          const doc = new jsPDF();

          // การเพิ่มฟอนต์จากไฟล์ (ที่อยู่ในโฟลเดอร์ fonts)
          doc.addFont('../../assets/font/THSarabunNew.ttf', 'THSarabunNew', 'normal');
          doc.addFont('../../assets/font/THSarabunNew_Italic.ttf', 'THSarabunNewItalic', 'italic');
          doc.addFont('../../assets/font/THSarabunNew_Bold.ttf', 'THSarabunNewBold', 'bold');
          doc.addFont('../../assets/font/THSarabunNew_BoldItalic.ttf', 'THSarabunNewBoldItalic', 'bolditalic');
          doc.setFont('THSarabunNew', 'normal'); // กำหนดฟอนต์เริ่มต้น

          doc.text('รายชื่อผู้ป่วยทั้งหมดที่ต้องติดตาม', 10, 10);

          const tableData = [];
          const selectedRows = document.querySelectorAll('input[type="checkbox"]:checked');

          // ตรวจสอบว่าไม่มีแถวที่ถูกเลือก
          if (selectedRows.length === 0) {
            console.log("ไม่มีแถวที่ถูกเลือก");
            return;
          }

          // ประมวลผลแถวที่ถูกเลือก
          selectedRows.forEach(checkbox => {
            const row = checkbox.closest('tr');
            if (!row) {
              console.log("ไม่พบแถวที่มี checkbox นี้");
              return;
            }

            // ตรวจสอบว่าแถวนี้มีข้อมูลหรือไม่
            const rowData = {
              'ชื่อผู้ป่วย': '',          // กำหนดค่าพื้นฐาน
              'ประเภทโรค': '',
              'ประเภทผู้ป่วย': '',
              'วันที่เริ่มติดตาม': '',
              'กำหนดส่งงาน': '',
              'ผู้รับผิดชอบ': ''
            };

            let isRowEmpty = true;

            // เก็บข้อมูลจากแต่ละเซลล์ของแถวในออบเจ็กต์
            Array.from(row.querySelectorAll('td')).forEach((cell, index) => {
              const cellText = cell.textContent.trim();

              // ตรวจสอบว่ามีข้อมูลในเซลล์หรือไม่
              if (cellText !== '' && cellText !== 'ไม่ระบุ') {
                isRowEmpty = false; // ถ้ามีข้อมูลให้เปลี่ยนสถานะแถวเป็นไม่ว่าง
              }

              // กำหนดค่าที่จะเก็บในออบเจ็กต์ตามลำดับที่ถูกต้อง
              switch (index) {
                case 1:
                  rowData['ชื่อผู้ป่วย'] = cellText || "ชื่อผู้ป่วยไม่มี";
                  break;
                case 2:
                  rowData['ประเภทโรค'] = cellText || "ประเภทโรคไม่มี";
                  break;
                case 3:
                  rowData['ประเภทผู้ป่วย'] = cellText || "ประเภทผู้ป่วยไม่มี";
                  break;
                case 4:
                  rowData['วันที่เริ่มติดตาม'] = cellText || "วันที่เริ่มติดตามไม่มี";
                  break;
                case 5:
                  rowData['กำหนดส่งงาน'] = cellText || "กำหนดส่งงานไม่มี";
                  break;
                case 6:
                  rowData['ผู้รับผิดชอบ'] = cellText || "ผู้รับผิดชอบไม่มี";
                  break;
                default:
                  break;
              }
            });

            // เพิ่มแถวข้อมูลใน tableData หากแถวนี้ไม่ว่าง
            if (!isRowEmpty) {
              tableData.push(rowData);
            }
          });

          // Log the table data to the console
          console.log("Table Data (as Objects):", tableData);

          // สร้างตารางใน PDF
          if (typeof doc.autoTable === "function") {
            // Log the transformed data that will be passed to autoTable (converted to an array of values)
            const tableValues = tableData.map(row => [
              row['ชื่อผู้ป่วย'],
              row['ประเภทโรค'],
              row['ประเภทผู้ป่วย'],
              row['วันที่เริ่มติดตาม'],
              row['กำหนดส่งงาน'],
              row['ผู้รับผิดชอบ']
            ]);
            console.log("Table Data (as Array of Values):", tableValues);

            // สร้างตารางใน PDF ด้วยการตั้งค่าเพิ่มเติม
            doc.autoTable({
              head: [
                ['ชื่อผู้ป่วย', 'ประเภทโรค', 'ประเภทผู้ป่วย', 'วันที่เริ่มติดตาม', 'กำหนดส่งงาน', 'ผู้รับผิดชอบ']
              ], // กำหนดหัวตาราง
              body: tableValues, // ข้อมูลตาราง
              theme: 'grid',
              styles: {
                font: 'THSarabunNew',
                halign: 'center',    // กำหนดการจัดข้อความกลาง
                fontSize: 12,        // ขนาดฟอนต์
              },
              headStyles: {
                fillColor: [41, 128, 185], // สีพื้นหลังหัวตาราง
                textColor: [255, 255, 255], // สีข้อความในหัวตาราง
                font: 'THSarabunNewBold',   // ฟอนต์หัวตารางเป็นตัวหนา
                fontSize: 12,               // ขนาดฟอนต์หัวตาราง
              },
              columnStyles: {
                0: { halign: 'left' },   // ข้อความในคอลัมน์แรก (ชื่อผู้ป่วย) จัดชิดซ้าย
                1: { halign: 'left' },   // ข้อความในคอลัมน์สอง (ประเภทโรค) จัดชิดซ้าย
                2: { halign: 'left' },   // ข้อความในคอลัมน์สาม (ประเภทผู้ป่วย) จัดชิดซ้าย
                3: { halign: 'center' }, // ข้อความในคอลัมน์สี่ (วันที่เริ่มติดตาม) จัดกลาง
                4: { halign: 'center' }, // ข้อความในคอลัมน์ห้า (กำหนดส่งงาน) จัดกลาง
                5: { halign: 'center' }  // ข้อความในคอลัมน์หก (ผู้รับผิดชอบ) จัดกลาง
              },
              margin: { top: 20 },
            });

            // บันทึกไฟล์ PDF
            doc.save('รายชื่อผู้ป่วยทั้งหมดที่ต้องติดตาม.pdf');
          } else {
            console.error("autoTable function not found!");
          }
        }

        // Event Listener สำหรับฟิลเตอร์
        patientNameFilter.addEventListener('input', filterTable);
        diseaseFilter.addEventListener('change', filterTable);
        patientTypeFilter.addEventListener('change', filterTable);
        monitorStartDateFilter.addEventListener('change', filterTable);
        monitorDeadlineFilter.addEventListener('change', filterTable);
        responsibleNameFilter.addEventListener('input', filterTable);

        // เปิดป๊อปอัปเมื่อคลิกปุ่ม
        downloadPdfButton.addEventListener('click', openPopup);
        closePopupIcon.addEventListener('click', closePopup);

        // สร้าง PDF เมื่อคลิกปุ่ม
        generatePdfButton.addEventListener('click', generatePdf);
      });
    </script>

    <div id="button-container">
      <button id="assign-button" style="display: none;">มอบหมายงาน</button>
    </div>

    <div class="table-container">
      <table class="patient-table">
        <thead>
          <tr>
            <th>
              <input type="checkbox" id="select-all" class="select-all">
            </th>
            <th>ชื่อผู้ป่วย</th>
            <th>โรคประจำตัว</th>
            <th>ประเภทผู้ป่วย</th>
            <th>วันที่เริ่มติดตาม</th>
            <th>กำหนดส่งงาน</th>
            <th>ครั้งที่ติดตาม</th>
            <th>สถานะเข้ารับการรักษา</th>
            <th>สถานะการติดตาม</th>
            <th>การจัดการ</th>
          </tr>
        </thead>
        <tbody id="patient-info-body">
          <!-- ข้อมูลผู้ป่วยจะถูกเติมที่นี่ -->
        </tbody>
      </table>
      <!-- Pagination Controls -->
      <div id="pagination">
        <button id="prevPage" onclick="changePage(-1)"><i class='bx bx-chevron-left'></i></button>
        <button id="nextPage" onclick="changePage(1)"><i class='bx bx-chevron-right'></i></button>
      </div>
    </div>

    <style>
      /* กำหนดสไตล์ให้กับ container ของ pagination */
      #pagination {
        display: flex;
        justify-content: center;
        margin-top: 20px;
      }

      /* กำหนดสไตล์ให้กับปุ่ม prev และ next */
      #prevPage,
      #nextPage {
        background-color: transparent;
        /* ไม่มีพื้นหลัง */
        color: #007bff;
        /* สีตัวอักษร */
        border: 2px solid #007bff;
        /* ขอบปุ่มมีสีเขียว */
        padding: 5px 5px;
        margin: 0 10px;
        font-size: 16px;
        cursor: pointer;
        border-radius: 5px;
        transition: all 0.3s ease;
      }

      /* ปรับสไตล์ให้กับปุ่มเมื่อ hover */
      #prevPage:hover,
      #nextPage:hover {
        background-color: #007bff;
        color: white;
      }

      /* ทำให้ปุ่มที่ไม่สามารถคลิกได้มีลักษณะเหมือนปิดใช้งาน */
      #prevPage:disabled,
      #nextPage:disabled {
        color: #ccc;
        border-color: #ccc;
        cursor: not-allowed;
      }

      /* เมื่อ hover ปุ่มที่ไม่สามารถคลิกได้ */
      #prevPage:disabled:hover,
      #nextPage:disabled:hover {
        background-color: transparent;
        color: #ccc;
      }

      /* ปุ่มแสดงลูกศร */
      #prevPage i,
      #nextPage i {
        font-size: 20px;
      }
    </style>

    <!-- Overlay -->
    <div id="overlay"
      style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999;">
    </div>

    <div id="confirmation-popup" style="display:none;">
      <div class="popup-content">
        <h2>กรุณาตรวจสอบรายชื่อผู้ป่วยที่ต้องการติดตาม</h2>
        <p id="patient-count"></p>
        <div id="patient-table-wrapper">
          <table id="patient-table">
            <thead>
              <tr>
                <th>ID ผู้ป่วย</th>
                <th>ชื่อผู้ป่วย</th>
                <th>โรคประจำตัว</th>
                <th>เขตที่อยู่อาศัย</th> <!-- คอลัมน์ใหม่ -->
                <th>ผู้รับผิดชอบ</th> <!-- คอลัมน์ใหม่ -->
              </tr>
            </thead>
            <tbody id="patient-list"></tbody>
          </table>
        </div>
        <div class="text">
          <label for="monitor-start-date">วันที่เริ่มติดตาม:</label>
          <input type="date" id="monitor-start-date" required>
          <label for="monitor-deadline">กำหนดส่งผลการติดตาม:</label>
          <input type="date" id="monitor-deadline" required>
        </div>
        <button type="Yes" id="confirm-assign">ยืนยัน</button>
        <button type="No" id="cancel-assign">ยกเลิก</button>
      </div>
    </div>

    <script>
      // ดึงวันที่ปัจจุบัน
      const today = new Date().toISOString().split('T')[0];

      // ตั้งค่า min เป็นวันที่ปัจจุบัน
      document.getElementById('monitor-deadline').setAttribute('min', today);
      document.getElementById('monitor-start-date').setAttribute('min', today); // วันที่เริ่มติดตามต้องไม่ย้อนกลับ

      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('cancel-assign').addEventListener('click', function () {
          const confirmationPopup = document.getElementById('confirmation-popup');
          const overlay = document.getElementById('overlay');
          const assignButton = document.getElementById('assign-button');

          if (confirmationPopup) {
            confirmationPopup.style.display = 'none';
          }
          if (overlay) {
            overlay.style.display = 'none';
          }
          if (assignButton) {
            assignButton.style.display = 'block';
          }
        });

        const assignButton = document.getElementById('assign-button');
        const patientCountElement = document.getElementById('patient-count');
        const patientList = document.getElementById('patient-list');
        const checkboxes = document.querySelectorAll('.patient-checkbox');

        checkboxes.forEach(checkbox => {
          checkbox.addEventListener('change', function () {
            const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
            assignButton.style.display = anyChecked ? 'block' : 'none';
          });
        });

        // ปุ่มมอบหมายงาน
        assignButton.addEventListener('click', function () {
          const selectedPatients = Array.from(document.querySelectorAll('.patient-checkbox:checked')).map(checkbox => {
            return {
              patientId: parseInt(checkbox.value),
              fullName: checkbox.getAttribute('data-full-name'),
              diseaseType: checkbox.getAttribute('data-disease-type'),
              area: checkbox.getAttribute('data-patient_address_area'),  // ข้อมูลเขตที่อยู่อาศัย
              responsiblePerson: checkbox.getAttribute('data-responsible') // ข้อมูลผู้รับผิดชอบ
            };
          });

          // ตรวจสอบว่าเขตที่อยู่อาศัยและผู้รับผิดชอบเป็น null หรือไม่
          const invalidPatients = selectedPatients.filter(patient => {
            console.log('ตรวจสอบผู้ป่วย:', patient);  // ดูข้อมูลผู้ป่วยที่เลือก
            console.log('เขตที่อยู่อาศัย:', patient.area); // ดูค่าของ area
            console.log('ผู้รับผิดชอบ:', patient.responsiblePerson); // ดูค่าของ responsiblePerson

            return !patient.area || !patient.responsiblePerson || patient.area === 'ไม่มีการกำหนด' || patient.responsiblePerson === 'ไม่มีการกำหนด';
          });

          if (invalidPatients.length > 0) {
            alert('ไม่สามารถเลือกติดตามได้เนื่องจากยังไม่มีการกำหนดว่าใครคือผู้รับผิดชอบ');
            return;
          }

          if (selectedPatients.length === 0) {
            alert('กรุณาเลือกผู้ป่วยก่อนมอบหมายงาน');
            return;
          }

          if (patientCountElement) {
            patientCountElement.textContent = `จำนวนผู้ป่วยที่เลือก: ${selectedPatients.length}`;
          }

          if (patientList) {
            patientList.innerHTML = '';
            selectedPatients.forEach(patient => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
        <td>${patient.patientId}</td>
        <td>${patient.fullName}</td>
        <td>${patient.diseaseType}</td>
        <td>${patient.area}</td> <!-- แสดงข้อมูลเขตที่อยู่อาศัย -->
        <td>${patient.responsiblePerson}</td> <!-- แสดงข้อมูลผู้รับผิดชอบ -->
        `;
              patientList.appendChild(tr);
            });
          }

          // ซ่อนปุ่ม "มอบหมายงาน"
          assignButton.style.display = 'none';

          // แสดงป๊อปอัป
          document.getElementById('confirmation-popup').style.display = 'block';
          document.getElementById('overlay').style.display = 'flex';
        });

        // ปุ่มยืนยันมอบหมายงาน
        document.getElementById('confirm-assign').addEventListener('click', async function () {
          const selectedPatients = Array.from(document.querySelectorAll('.patient-checkbox:checked')).map(checkbox => {
            return {
              patientId: parseInt(checkbox.value),
              area: checkbox.getAttribute('data-patient_address_area'),
              responsiblePerson: checkbox.getAttribute('data-responsible')
            };
          });

          // ตรวจสอบข้อมูลเขตที่อยู่อาศัยและผู้รับผิดชอบก่อนการอัปเดตสถานะ
          const invalidPatients = selectedPatients.filter(patient =>
            !patient.area || !patient.responsiblePerson || patient.area === 'ไม่มีการกำหนด' || patient.responsiblePerson === 'ไม่มีการกำหนด');
          if (invalidPatients.length > 0) {
            alert('ไม่สามารถอัปเดตสถานะการติดตามสำหรับผู้ป่วยที่ยังไม่มีข้อมูลเขตที่อยู่อาศัยหรือผู้รับผิดชอบ');
            return;
          }

          const monitorStatus = 'กำลังติดตาม'; // สถานะการติดตามที่เราต้องการ
          const monitorDeadline = document.getElementById('monitor-deadline').value; // วันหมดอายุ
          const monitorStartDate = document.getElementById('monitor-start-date').value; // วันเริ่มติดตาม

          try {
            const response = await fetch('/chiracarehospital/backend/sql/monitoring/update_patient_status.php', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                monitorStatus: monitorStatus,
                patientIds: selectedPatients.map(patient => patient.patientId),
                monitorDeadline: monitorDeadline,
                monitorStartDate: monitorStartDate // ส่งวันที่เริ่มติดตาม
              })
            });

            const responseData = await response.json();

            if (responseData.status === 'success') {
              alert(`อัปเดตสถานะสำเร็จ: ${responseData.updated_count} รายการ`);
              document.getElementById('confirmation-popup').style.display = 'none';
              document.getElementById('overlay').style.display = 'none';
              window.location.reload(); // รีเฟรชหน้าเว็บ
            } else {
              alert(`เกิดข้อผิดพลาด: ${responseData.message}`);
            }
          } catch (error) {
            console.error('Error:', error);
            alert('เกิดข้อผิดพลาดในการอัปเดตสถานะการติดตาม: ' + error.message);
          }
        });
      });

      // ฟิลเตอร์กรองข้อมูลในตาราง
      function filterData() {
        const searchName = document.getElementById('searchPatientInput').value.toLowerCase();
        const treatmentCount = document.getElementById('treatmentCountFilter').value;
        const appointmentDate = document.getElementById('appointmentDateFilter').value;
        const deadlineDate = document.getElementById('DeadlineDateFilter').value;
        const treatmentStatus = document.getElementById('treatmentStatusFilter').value;
        const followUpStatus = document.getElementById('followUpStatusFilter').value;

        const rows = document.querySelectorAll('#patient-info-body tr');

        rows.forEach(row => {
          const name = row.cells[1].textContent.toLowerCase(); // ชื่อผู้ป่วย
          const treatment = row.cells[2].textContent; // โรคประจำตัว
          const appointment = row.cells[4].textContent; // วันที่เริ่มติดตาม (สมมติว่าช่องที่สาม)
          const deadline = row.cells[5].textContent; // กำหนดส่งงาน
          const status = row.cells[7].textContent; // สถานะการรักษา
          const followup = row.cells[8].textContent; // สถานะการติดตาม

          let isVisible = true;

          // กรองตามชื่อ
          if (searchName && !name.includes(searchName)) {
            isVisible = false;
          }
          // กรองตามโรคประจำตัว
          if (treatmentCount && treatmentCount !== treatment) {
            isVisible = false;
          }
          // กรองตามวันที่เริ่มติดตาม
          if (appointmentDate && appointment !== appointmentDate) {
            isVisible = false;
          }
          // กรองตามกำหนดส่งงาน 
          if (deadlineDate && deadline !== deadlineDate) {
            isVisible = false;
          }

          // กรองตามสถานะการรักษา
          if (treatmentStatus && treatmentStatus !== "ทั้งหมด" && treatmentStatus !== status) {
            isVisible = false;
          }

          if (followUpStatus && followUpStatus !== "ทั้งหมด" && followUpStatus !== followup) {
            isVisible = false;
          }

          // แสดงหรือซ่อนแถว
          row.style.display = isVisible ? '' : 'none';
        });
      }

      document.addEventListener('DOMContentLoaded', function () {
        filterData();
      });
    </script>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        fetchPatientData();

        let currentPage = 1;
        const rowsPerPage = 10;
        let patientData = [];

        async function fetchPatientData() {
          const tbody = document.querySelector('.patient-table tbody');
          try {
            const response = await fetch('/chiracarehospital/backend/sql/monitoring/patient_list.php');
            if (!response.ok) throw new Error('Network response was not ok: ' + response.statusText);

            patientData = await response.json();

            if (!Array.isArray(patientData) || patientData.length === 0) {
              tbody.innerHTML = `<tr><td colspan="10">ไม่มีข้อมูลผู้ป่วย</td></tr>`;
              document.getElementById('assign-button').style.display = 'none';
              return;
            }

            // เรียงลำดับตามชื่อก่อนเสมอ
            sortData('name');

          } catch (error) {
            console.error('Error:', error);
            tbody.innerHTML = `<tr><td colspan="10">เกิดข้อผิดพลาดในการดึงข้อมูล: ${error.message}</td></tr>`;
            document.getElementById('assign-button').style.display = 'none';
          }
        }

        function renderTable(data) {
          const tbody = document.querySelector('.patient-table tbody');
          const start = (currentPage - 1) * rowsPerPage;
          const end = start + rowsPerPage;
          const pageData = data.slice(start, end);

          tbody.innerHTML = '';

          pageData.forEach(patient => {
            const isMonitoringPending = patient.monitor_status === 'ยังไม่ได้ติดตาม';
            const isMonitoringFailed = patient.monitor_status === 'ติดตามล้มเหลว';

            const row = document.createElement('tr');
            row.innerHTML = `
        <td>${isMonitoringPending || isMonitoringFailed ? `<input type='checkbox' class='patient-checkbox' value='${patient.patient_id}' data-full-name='${patient.full_name}' data-disease-type='${patient.disease_type}' data-patient_address_area='${patient.patient_address_area}' data-responsible='${patient.responsible_person_name}'>` : `<div class="unselectable-box"></div>`}</td>
        <td>${patient.full_name || `<span class="no-data">ไม่มีข้อมูล</span>`}</td>
        <td>${patient.disease_type || `<span class="no-data">ไม่มีข้อมูล</span>`}</td>
        <td>${patient.patient_type || `<span class="no-data">ไม่มีข้อมูล</span>`}</td>
        <td>${patient.monitor_date || `<span class="no-data">ยังไม่มี</span>`}</td>
        <td>${patient.monitor_deadline || `<span class="no-data">ยังไม่มี</span>`}</td>
        <td>${patient.monitor_round || `<span class="no-data">ยังไม่มี</span>`}</td>
        <td><span class='status ${getStatusClass(patient.treatment_status)}'>${patient.treatment_status || `<span class="no-data">ยังไม่มี</span>`}</span></td>
        <td><span class='status ${getStatusClass(patient.monitor_status)}'>${patient.monitor_status || `<span class="no-data">ไม่ต้องติดตาม</span>`}</span></td>
        <td>
          <button class='action-btn' title='แก้ไขข้อมูล' onclick="location.href='edittracking.html?patient_id=${patient.patient_id}';"><i class='bx bx-edit'></i></button>
          <button class='action-btn' title='ดูเพิ่มเติม' onclick="location.href='moreinfo.html?patient_id=${patient.patient_id}';"><i class='bx bx-right-arrow-alt'></i></button>
        </td>`;
            tbody.appendChild(row);
          });

          updateAssignButtonVisibility();
        }

        function setupPagination(data) {
          const totalPages = Math.ceil(data.length / rowsPerPage);
          document.getElementById('prevPage').disabled = currentPage === 1;
          document.getElementById('nextPage').disabled = currentPage === totalPages;

          document.getElementById('prevPage').onclick = () => changePage(-1);
          document.getElementById('nextPage').onclick = () => changePage(1);
        }

        function changePage(direction) {
          const totalPages = Math.ceil(patientData.length / rowsPerPage);

          if (direction === -1 && currentPage > 1) {
            currentPage--;
          } else if (direction === 1 && currentPage < totalPages) {
            currentPage++;
          }

          renderTable(patientData);
          setupPagination(patientData);
        }

        function sortData(sortOption = document.getElementById('sortOption').value) {
          if (sortOption === 'status') {
            const statusOrder = {
              'ยังไม่ได้ติดตาม': 1,
              'ติดตามล้มเหลว': 2,
              'กำลังติดตาม': 3,
              'ติดตามแล้ว': 4
            };

            patientData.sort((a, b) => {
              const statusA = statusOrder[a.monitor_status] || 5;
              const statusB = statusOrder[b.monitor_status] || 5;
              return statusA - statusB;
            });
          } else if (sortOption === 'name') {
            patientData.sort((a, b) => (a.full_name || '').localeCompare(b.full_name || '', 'th', { sensitivity: 'base' }));
          } else if (sortOption === 'latest') {
            patientData.sort((a, b) => new Date(b.monitor_date || 0) - new Date(a.monitor_date || 0));
          }

          currentPage = 1;
          renderTable(patientData);
          setupPagination(patientData);
        }

        function getStatusClass(status) {
          switch (status) {
            case 'ยังไม่ได้ติดตาม': return 'uncomplete';
            case 'กำลังติดตาม': return 'in-progress';
            case 'ติดตามแล้ว': return 'completed';
            case 'ติดตามล้มเหลว': return 'failed';
            default: return 'other';
          }
        }

        function updateAssignButtonVisibility() {
          const selectedPatients = document.querySelectorAll('.patient-checkbox:checked');
          document.getElementById('assign-button').style.display = selectedPatients.length > 0 ? 'block' : 'none';
        }

        document.getElementById('select-all').addEventListener('change', function () {
          const checkboxes = document.querySelectorAll('.patient-checkbox');
          checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
          });
          updateAssignButtonVisibility();
        });

        document.addEventListener('change', function (event) {
          if (event.target.classList.contains('patient-checkbox')) {
            updateAssignButtonVisibility();
          }
        });

        document.getElementById('sortOption').addEventListener('change', function () {
          sortData(this.value);
        });
      });
    </script>

    <script>
      // เรียกฟังก์ชัน checkAuth() เพื่อตรวจสอบ token
      checkAuth();

      // Load sidebar
      fetch('sidebar.html')
        // ใช้ fetch เพื่อดึงข้อมูล sidebar.html
        .then(response => response.text())
        // แปลงข้อมูลที่ได้รับเป็นข้อความ
        .then(data => {
          document.getElementById('sidebar-container').innerHTML = data;
          // นำข้อมูลที่ดึงมาแสดงใน sidebar-container
          loadSidebarScript();
          // เรียกฟังก์ชัน loadSidebarScript() เพื่อทำงานเพิ่มเติมกับ sidebar
        });

      // Load topbar and set the page title
      fetch('topbar.html')
        // ใช้ fetch เพื่อดึงข้อมูล topbar.html
        .then(response => response.text())
        // แปลงข้อมูลที่ได้รับเป็นข้อความ
        .then(data => {
          document.getElementById('topbar-container').innerHTML = data;
          // นำข้อมูลที่ดึงมาแสดงใน topbar-container
          document.getElementById('page-title').textContent = 'ติดตามผู้ป่วยที่ไม่มาเข้ารับการรักษา';
          // กำหนดชื่อเรื่องของหน้าเป็น 'หน้าหลัก'

          // Re-run user.js script after loading topbar
          const script = document.createElement('script');
          // สร้างแท็ก script ใหม่
          script.src = '../method/user.js';
          // กำหนดแหล่งที่มาของ script เป็น user.js
          document.body.appendChild(script);
          // เพิ่มแท็ก script ลงใน body ของเอกสารเพื่อทำการโหลดสคริปต์
        });
    </script>

</body>

<style>
  .no-data {
    color: #c0c0c0;
    /* กำหนดสีของข้อความเป็นสีแดง */
    /* font-style: italic; */
  }

  .unselectable-box {
    width: 20px;
    height: 20px;
    background-color: #d9d9d9;
    /* สีพื้นหลังทึบ */
    border: 1px solid #a6a6a6;
    /* สีขอบ */
    border-radius: 4px;
    display: inline-block;
  }

  td .patient-checkbox {
    width: 20px;
    height: 20px;
    border-radius: 4px;
  }

  th .select-all {
    width: 20px;
    height: 20px;
    border-radius: 4px;
  }

  /* การตั้งค่ารูปแบบของตาราง */
  #patient-table {
    width: 100%;
    border-collapse: collapse;
    /* รวมเส้นขอบให้ดูเรียบ */
    margin-top: 5px;
    margin-bottom: 20px;
  }

  /* การตั้งค่าของแต่ละเซลล์ในตาราง */
  #patient-table th,
  #patient-table td {
    padding: 10px;
    /* เพิ่มช่องว่างในเซลล์ */
    text-align: left;
    /* จัดการข้อความในแต่ละเซลล์ให้ชิดซ้าย */
    border: 1px solid #ddd;
    /* เส้นขอบที่อ่อน */
  }

  /* การตั้งค่าให้แถวที่เป็น header มีลักษณะเด่น */
  #patient-table th {
    background-color: #f2f2f2;
    /* พื้นหลังสีอ่อน */
    font-weight: bold;
    /* ตัวหนาสำหรับหัวตาราง */
  }

  /* การตั้งค่าของแถวที่มีเส้นขอบหนา */
  #patient-table tbody tr:nth-child(even) {
    background-color: #f9f9f9;
    /* สีพื้นหลังของแถวคู่ */
  }

  #patient-table tbody tr:nth-child(odd) {
    background-color: #fff;
    /* สีพื้นหลังของแถวคี่ */
  }

  /* ทำให้ตารางมีลูกเลื่อนแนวตั้ง */
  #patient-table-wrapper {
    display: block;
    max-height: 300px;
    /* กำหนดความสูงสูงสุด */
    overflow-y: auto;
    /* เพิ่มลูกเลื่อนแนวตั้ง */
  }

  /* ปรับให้ <thead> และ <tbody> แสดงเป็นตารางเดียวกัน */
  #patient-table thead,
  #patient-table tbody {
    display: table;
    width: 100%;
    table-layout: fixed;
    border-collapse: collapse;
  }

  /* ทำให้คอลัมน์ header (thead) ติดอยู่ด้านบน */
  #patient-table thead {
    z-index: 2;
    /* ให้แน่ใจว่าหัวตารางจะอยู่ด้านบน */
    background-color: #f2f2f2;
    /* ทำให้หัวตารางมีพื้นหลัง */
  }

  #patient-count {
    margin-top: 20px;
  }
</style>

</html>