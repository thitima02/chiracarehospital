<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>โรงพยาบาลค่ายจิรประวัติ</title>
  <link rel="stylesheet" href="../../css/staffinfo.css">
  <link rel="stylesheet" href="../../styles.css">
  <link rel="stylesheet" href="../../css/sidebar.css">
  <link rel="stylesheet" href="../../css/topbar.css">
  <link rel="stylesheet" href="../../css/logo.css">
  <script src="../method/logout.js"></script>
  <!-- Import icon -->
  <link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="../method/logout.js"></script>
  <!-- เชื่อมโยงไฟล์ JavaScript สำหรับจัดการการออกจากระบบ -->
  <script src="../method/user.js"></script>
  <!-- เชื่อมโยงไฟล์ JavaScript สำหรับการจัดการข้อมูลผู้ใช้ -->
  <script src="../method/loadSidebarScript.js"></script>
  <!-- เชื่อมโยงไฟล์ JavaScript สำหรับโหลดสคริปต์ sidebar -->
  <script src="../method/checkAuth.js"></script>
  <!-- เชื่อมโยงไฟล์ JavaScript สำหรับตรวจสอบการพิสูจน์ตัวตน (Authentication) -->
</head>

<body style="background-color:#edeff1;">
  <!-- Sidebar will be loaded here -->
  <div id="sidebar-container"></div>

  <!-- Topbar will be loaded here -->
  <div id="topbar-container"></div>

  <div class="patientinfo-container">
    <section class="filter-section" style="justify-content: center;">
      <div class="filter-container">
        <div class="filter-item search-bar">
          <h5>ค้นหารายชื่อ</h5>
          <input type="text" placeholder="ค้นหาที่นี่..." class="search-input" id="searchPatientInput"
            oninput="filterData()">
          <i class='bx bx-search search-icon'></i>
        </div>
        <div class="filter-item">
          <h5>หน้าที่ที่รับผิดชอบ</h5>
          <select class="dropdown-filter" id="treatmentCountFilter" onchange="filterData()">
            <option value="">ทั้งหมด</option>
            <option value="โรคความดันโลหิตสูง">อาสาสมัครสาธารณสุข</option>
            <option value="โรคอ้วน">เสนารักษ์</option>
          </select>
          <i class='bx bx-chevron-down down-icon'></i>
        </div>

        <div class="filter-item">
          <h5>เขตที่รับผิดชอบ</h5>
          <select class="dropdown-filter" id="treatmentStatusFilter" onchange="filterData()">
            <option value="ทั้งหมด">ทั้งหมด</option>
            <option value="1">เขต 1</option>
            <option value="2">เขต 2</option>
            <option value="3">เขต 3</option>
            <option value="4">เขต 4</option>
            <option value="5">เขต 5</option>
            <option value="6">เขต 6</option>
            <option value="7">เขต 7</option>
            <option value="8">เขต 8</option>
            <option value="9">เขต 9</option>
            <option value="10">เขต 10</option>
            <option value="11">เขต 11</option>
            <option value="12">เขต 12</option>
            <option value="13">เขต 13</option>
            <option value="14">เขต 14</option>
            <option value="15">เขต 15</option>
            <option value="15">นอกเขต</option>
          </select>
          <i class='bx bx-chevron-down down-icon'></i>
        </div>

        <div class="filter-item search-bar">
          <h5>เลขบัตรประชาชน</h5>
          <input type="text" placeholder="ค้นหาที่นี่..." class="search" id="searchPatientInput"
            style="color: aquamarine;" oninput="filterData()">
          <i class='bx bx-search search-other-icon'></i>
        </div>

        <div class="filter-item search-bar">
          <h5>เบอร์โทรศัพท์</h5>
          <input type="text" placeholder="ค้นหาที่นี่..." class="search" id="searchPatientInput" oninput="filterData()">
          <i class='bx bx-search search-other-icon'></i>
        </div>
      </div>
    </section>

    <div class="table-container">
      <table class="patient-table">
        <thead>
          <tr>
            <th>ชื่อ - นามสกุล</th>
            <th>หน้าที่ที่รับผิดชอบ</th>
            <th>เขตที่รับผิดชอบ</th>
            <th>เลขบัตรประชาชน</th>
            <th>เบอร์โทรศัพท์</th>
            <th>จัดการ</th>
          </tr>
        </thead>

        <tbody id="patient-info-body">
          <!-- ข้อมูลจะแสดงที่นี่ -->
        </tbody>
      </table>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    $(document).ready(function () {
      // เรียกข้อมูลจาก API เมื่อหน้าเว็บโหลดเสร็จ
      $.getJSON('/chiracarehospital/backend/sql/users/getAlluser.php', function (response) {
        if (response.status === 'success') {
          var staffs = response.data;
          var rows = '';

          // วนลูปข้อมูลผู้ใช้เพื่อแสดงในตาราง
          staffs.forEach(function (staff) {
            // กรองเฉพาะผู้ที่มีสถานะเป็น 'อาสาสมัครสาธารณสุข' หรือ 'เสนารักษ์'
            if (staff.department === 'อาสาสมัครสาธารณสุข' || staff.department === 'เสนารักษ์') {
              rows += '<tr>';
              rows += '<td style="text-align: left; padding-left: 30px"><img src="../../assets/images/cat.jpg" alt="avatar"> ' + staff.full_name + '</td>';
              rows += '<td>' + staff.department + '</td>';
              rows += '<td>' + staff.responsibility_area + '</td>';
              rows += '<td>' + (staff.id_card ? staff.id_card : '-') + '</td>';
              rows += '<td>' + staff.phone_number + '</td>';
              rows += '<td>' +
                '<button class="action-btn" title="ดูผู้ป่วยที่รับผิดชอบ" onclick="moreStaff(\'' + staff.id + '\')" >' +
                '<i class="bx bx-handicap"></i> <p>ดูผู้ป่วยที่รับผิดชอบ</p>' +
                '</button>' +
                '</td>';
              rows += '</td>';
              rows += '</tr>';
            }
          });

          // แทรกข้อมูลในตาราง
          $('#patient-info-body').html(rows);
        } else {
          alert(response.message);
        }
      });
    });

    function moreStaff(id) {
      window.location.href = `morestaff.html?id=${id}`;
      if (id) {
        console.log("Viewing Patient ID:", id);  // เช็คค่า ID ที่ส่งเข้ามา
      } else {
        console.error("ไม่พบ ID ของผู้ป่วย"); // แจ้งเตือนหาก id ไม่ถูกต้อง
      }
    }

    // filter data 
    function filterData() {
      var searchValue = document.getElementById('searchPatientInput').value.toLowerCase();
      var rows = document.querySelectorAll('#patient-info-body tr');

      rows.forEach(function (row) {
        var staffName = row.cells[0].innerText.toLowerCase();
        var staffstatus = row.cells[1].innerText.toLowerCase();
        var staffarea = row.cells[2].innerText;
        var staffphonenumber = row.cells[4].innerText;

        var isNameMatch = staffName.includes(searchValue);
        var isAreaMatch = staffarea.includes(searchValue);
        var isPhoneMatch = staffphonenumber.includes(searchValue);

        if (isNameMatch || isAreaMatch || isPhoneMatch) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }
  </script>

  <script>
    // เรียกฟังก์ชัน checkAuth() เพื่อตรวจสอบ token
    checkAuth();

    // Load sidebar
    fetch('sidebar.html')
      // ใช้ fetch เพื่อดึงข้อมูล sidebar.html
      .then(response => response.text())
      // แปลงข้อมูลที่ได้รับเป็นข้อความ
      .then(data => {
        document.getElementById('sidebar-container').innerHTML = data;
        // นำข้อมูลที่ดึงมาแสดงใน sidebar-container
        loadSidebarScript();
        // เรียกฟังก์ชัน loadSidebarScript() เพื่อทำงานเพิ่มเติมกับ sidebar
      });

    // Load topbar and set the page title
    fetch('topbar.html')
      // ใช้ fetch เพื่อดึงข้อมูล topbar.html
      .then(response => response.text())
      // แปลงข้อมูลที่ได้รับเป็นข้อความ
      .then(data => {
        document.getElementById('topbar-container').innerHTML = data;
        // นำข้อมูลที่ดึงมาแสดงใน topbar-container
        document.getElementById('page-title').textContent = 'จัดการข้อมูลเจ้าหน้าที่ผู้รับผิดชอบ';
        // กำหนดชื่อเรื่องของหน้าเป็น 'หน้าหลัก'

        // Re-run user.js script after loading topbar
        const script = document.createElement('script');
        // สร้างแท็ก script ใหม่
        script.src = '../method/user.js';
        // กำหนดแหล่งที่มาของ script เป็น user.js
        document.body.appendChild(script);
        // เพิ่มแท็ก script ลงใน body ของเอกสารเพื่อทำการโหลดสคริปต์
      });
  </script>
</body>

</html>