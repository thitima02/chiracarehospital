<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>โรงพยาบาลค่ายจิรประวัติ</title>
    <link rel="stylesheet" href="../../css/edittracking.css">
    <link rel="stylesheet" href="../../styles.css">
    <link rel="stylesheet" href="../../css/sidebar.css">
    <link rel="stylesheet" href="../../css/topbar.css">
    <link rel="stylesheet" href="../../css/logo.css">
    <link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>
    <script src="../method/logout.js"></script>
    <!-- เชื่อมโยงไฟล์ JavaScript สำหรับจัดการการออกจากระบบ -->
    <script src="../method/user.js"></script>
    <!-- เชื่อมโยงไฟล์ JavaScript สำหรับการจัดการข้อมูลผู้ใช้ -->
    <script src="../method/loadSidebarScript.js"></script>
    <!-- เชื่อมโยงไฟล์ JavaScript สำหรับโหลดสคริปต์ sidebar -->
    <script src="../method/checkAuth.js"></script>
    <!-- เชื่อมโยงไฟล์ JavaScript สำหรับตรวจสอบการพิสูจน์ตัวตน (Authentication) -->
</head>
<body style="background-color:#edeff1;">
    <div id="sidebar-container"></div>
    <div id="topbar-container"></div>

    <div class="container">
        <div class="profile-header">
            <img src="../../assets/images/cat.jpg" alt="โปรไฟล์" class="profile-img" id="profile-img">
            <!-- <div class="rank"></div>
            <div class="department"></div> -->
            <div class="full_name"></div>
        </div>
        

                    <!-- ข้อมูลการติดตามล่าสุด -->
                    <div class="follow-up-treatment">
                        <div class="follow-up-info">
                            <h3>ข้อมูลการติดตาม <span id="newUpdateDate">ไม่มีข้อมูล</span></h3>
                            <div class="form-row">
                                <label for="diseaseType"><strong>โรคประจำตัว :</strong></label>
                                <input type="text" id="diseaseType" readonly>
                            </div>
                            <div class="form-row">
                                <label for="missingAppointments"><strong>สาเหตุการขาดนัด :</strong></label>
                                <input type="text" id="missingAppointments" value="ไม่มีข้อมูล">
                            </div>
                            <div class="form-row">
                                <label for="generalCondition"><strong>อาการทั่วไป :</strong></label>
                                <input type="text" id="generalCondition" value="ไม่มีข้อมูล">
                            </div>
                            <div class="form-row">
                                <label for="vitalSigns"><strong>ค่าสัญญาณชีพ :</strong></label>
                                <input type="text" id="vitalSigns" value="ไม่มีข้อมูล">
                            </div>
                            <div class="form-row">
                                <label for="bloodSugarLevel"><strong>ค่าระดับน้ำตาลในเลือด :</strong></label>
                                <input type="text" id="bloodSugarLevel" value="ไม่มีข้อมูล">
                            </div>
                            <div class="form-row">
                                <label for="responsibleStaffFollowUp"><strong>เจ้าหน้าที่ที่รับผิดชอบ :</strong></label>
                                <input type="text" id="responsibleStaffFollowUp" value="ไม่มีข้อมูล">
                            </div>
                        </div>
            
                        <!-- ข้อมูลการรักษาล่าสุด -->
                        <div class="treatment-info">
                            <h3>ข้อมูลการรักษา <span id="NewUpdateDate">ไม่มีข้อมูล</span></h3>
                            <div class="form-row">
                                <label for="treatmentDiseaseType"><strong>โรคประจำตัว :</strong></label>
                                <input type="text" id="treatmentDiseaseType" readonly>
                            </div>
                            <div class="form-row">
                                <label for="treatmentDate"><strong>วันที่นัดหมายครั้งถัดไป :</strong></label>
                                <input type="date" id="treatmentDate" value="">
                            </div>
                            <div class="form-row">
                                <label for="responsibleStaffTreatment"><strong>เจ้าหน้าที่ที่รับผิดชอบ :</strong></label>
                                <input type="text" id="responsibleStaffTreatment" value="ไม่มีข้อมูล">
                            </div>
                            <div class="form-row">
                                <label for="treatmentNotes"><strong>หมายเหตุ :</strong></label>
                                <input type="text" id="treatmentNotes" value="ไม่มีข้อมูล">
                            </div>
                        </div>
                    </div>
            
                    <div class="buttons">
                        <button type="button" class="btn-back" id="backBtn">ย้อนกลับ</button>
                        <button id="save-status" type="button">บันทึกข้อมูล</button>
                    </div>
            </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            const patientId = getPatientIdFromURL();
            if (patientId) {
                await fetchPatientMedicalData(patientId);
            } else {
                alert('ไม่พบข้อมูลผู้ป่วย');
            }
        });

        function getPatientIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('patient_id');
        }

        async function fetchPatientMedicalData(patientId) {
            try {
                const response = await fetch(`/chiracarehospital/backend/sql/get_patient_data.php?patient_id=${patientId}`);
                const data = await response.json();

                if (data.patient_data && data.patient_data.length > 0) {
                    const patientMedicalInfo = data.patient_data[0];
                    document.getElementById('diseaseType').value = patientMedicalInfo.disease_type || 'ไม่มีข้อมูลโรค';
                } else {
                    document.getElementById('diseaseType').value = 'ไม่มีข้อมูลโรค';
                }
            } catch (error) {
                console.error('Error fetching patient data:', error);
                alert('เกิดข้อผิดพลาดในการดึงข้อมูลผู้ป่วย');
            }
        }
</script>
    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            const patientId = getPatientIdFromURL();
            if (patientId) {
                await loadTreatmentStatus(patientId); // โหลดข้อมูลสถานะการรักษา
                setupSaveButton(patientId); // ตั้งค่าปุ่มบันทึก
            } else {
                alert('ไม่พบข้อมูลผู้ป่วย');
            }
        });
    
        function getPatientIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('patient_id');
        }
    
        async function loadTreatmentStatus(patientId) {
            try {
                const response = await fetch('/chiracarehospital/backend/sql/get_treatment_information.php');
                const data = await response.json();
    
                if (data && Array.isArray(data)) {
                    const patientData = data.find(item => item.patient_id === patientId);
                    if (patientData) {
                        populateTreatmentStatusDropdown(patientData.treatment_status);
    
                        // กรอกข้อมูลในฟอร์ม
                        document.getElementById('diseaseType').value = patientData.disease_type || '';
    
                        renderTreatmentStatusPage(patientData); // แสดงสถานะปัจจุบัน
                    } else {
                        console.warn('ไม่พบข้อมูลการรักษาสำหรับผู้ป่วยนี้');
                        populateTreatmentStatusDropdown();
                    }
                } else {
                    console.error('รูปแบบข้อมูลที่ดึงมาไม่ถูกต้องหรือไม่มีข้อมูล');
                    populateTreatmentStatusDropdown();
                }
            } catch (error) {
                console.error('เกิดข้อผิดพลาดในการดึงข้อมูลสถานะการรักษา:', error);
                populateTreatmentStatusDropdown();
            }
        }
    
        function populateTreatmentStatusDropdown(selectedStatus = '') {
            const treatmentStatusSelect = document.getElementById('treatment-status');
            const statuses = [
                { value: 'มาตามนัด', text: 'มาตามนัด' },
                { value: 'ไม่มาตามนัด', text: 'ไม่มาตามนัด' }
            ];
    
            treatmentStatusSelect.innerHTML = '';
            statuses.forEach(status => {
                const option = document.createElement('option');
                option.value = status.value;
                option.textContent = status.text;
                if (status.value === selectedStatus) {
                    option.selected = true;
                }
                treatmentStatusSelect.appendChild(option);
            });
        }
    
        function setupSaveButton(patientId) {
            const saveButton = document.getElementById('save-status');
            if (!saveButton) {
                console.error('ไม่พบปุ่มบันทึกใน DOM');
                return;
            }
    
            saveButton.addEventListener('click', async function () {
                const selectedStatus = document.getElementById('treatment-status')?.value;
                const diseaseType = document.getElementById('diseaseType')?.value;
    
                // ตรวจสอบว่ามีการกรอกสถานะหรือไม่
                if (!selectedStatus) {
                    alert('กรุณาเลือกสถานะการรักษา');
                    return;
                }
    
                try {
                    const response = await fetch('/chiracarehospital/backend/sql/update_treatment_status.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            patient_id: patientId,
                            treatment_status: selectedStatus,
                            disease_type: diseaseType // โรคประจำตัว
                        }),
                    });
    
                    const result = await response.json();
                    if (result.status === 'success') {
                        alert('บันทึกข้อมูลสำเร็จ');
                        window.location.href = `statustracking.html?patient_id=${patientId}`;
                    } else {
                        alert('เกิดข้อผิดพลาดในการบันทึกข้อมูล: ' + (result.message || 'ไม่ทราบข้อผิดพลาด'));
                    }
                } catch (error) {
                    console.error('เกิดข้อผิดพลาดในการบันทึกข้อมูล:', error);
                    alert('เกิดข้อผิดพลาดในการบันทึกข้อมูล');
                }
            });
        }
    
        function renderTreatmentStatusPage(patientData) {
            const statusElement = document.getElementById('tracking-status');
            if (statusElement) {
                const translatedStatus = translateStatus(patientData.treatment_status);
                const statusClass = getStatusClass(translatedStatus);
    
                statusElement.textContent = `สถานะการรักษา: ${translatedStatus}`;
                statusElement.className = statusClass;
            }
        }
    
        function translateStatus(status) {
            const statusMapping = {
                'มาตามนัด': 'มาตามนัด',
                'ไม่มาตามนัด': 'ไม่มาตามนัด'
            };
    
            return statusMapping[status] || 'สถานะไม่ทราบ';
        }
    
        function getStatusClass(status) {
            const classMapping = {
                'มาตามนัด': 'มาตามนัด',
                'ไม่มาตามนัด': 'ไม่มาตามนัด'
            };
    
            return classMapping[status] || 'สถานะไม่ทราบ';
        }
    </script>
    
    
    
    
    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            const patientId = getPatientIdFromURL();
            if (patientId) {
                try {
                    await loadFollowUpStatus(patientId); // โหลดข้อมูลสถานะการติดตาม
                    setupSaveButton(patientId); // ตั้งค่าปุ่มบันทึก
                } catch (error) {
                    console.error('Error during initialization:', error);
                    alert('เกิดข้อผิดพลาดในการโหลดข้อมูล');
                }
            } else {
                alert('ไม่พบข้อมูลผู้ป่วย');
            }
        });
    
        // ดึง patient_id จาก URL
        function getPatientIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('patient_id');
        }
    
        // โหลดข้อมูลสถานะการติดตาม
        async function loadFollowUpStatus(patientId) {
            try {
                const response = await fetch('/chiracarehospital/backend/sql/get_monitor_information.php');
                if (!response.ok) {
                    throw new Error('Failed to fetch monitor information');
                }
                const data = await response.json();
    
                if (Array.isArray(data)) {
                    const patientData = data.find(item => item.patient_id === patientId);
                    if (patientData) {
                        populateFollowUpStatus(patientData.monitor_status);
    
                        // อัปเดตฟิลด์ในฟอร์ม
                        document.getElementById('reason').value = patientData.monitor_date || '';
                        document.getElementById('occupation').value = patientData.monitor_deadline || '';
                        document.getElementById('blood-level').value = patientData.monitor_round || '';
    
                        renderStatustrackingPage(patientData); // แสดงสถานะ
                    } else {
                        console.warn('ไม่พบข้อมูลผู้ป่วยในฐานข้อมูล');
                        populateFollowUpStatus(); // แสดงสถานะว่าง
                    }
                } else {
                    console.error('รูปแบบข้อมูลไม่ถูกต้อง');
                    populateFollowUpStatus();
                }
            } catch (error) {
                console.error('Error fetching follow-up status:', error);
                populateFollowUpStatus();
            }
        }
    
        // กำหนดสถานะการติดตามใน select
        function populateFollowUpStatus(selectedStatus = '') {
            const followUpStatusSelect = document.getElementById('follow-up-status');
            const statuses = [
                { value: 'ยังไม่ได้ติดตาม', text: 'ยังไม่ได้ติดตาม' },
                { value: 'กำลังติดตาม', text: 'กำลังติดตาม' },
                { value: 'ติดตามแล้ว', text: 'ติดตามแล้ว' },
                { value: 'ติดตามล้มเหลว', text: 'ติดตามล้มเหลว' }
            ];
    
            followUpStatusSelect.innerHTML = '';
            statuses.forEach(status => {
                const option = document.createElement('option');
                option.value = status.value;
                option.textContent = status.text;
                if (status.value === selectedStatus) {
                    option.selected = true;
                }
                followUpStatusSelect.appendChild(option);
            });
        }
    
        // ตั้งค่าให้ปุ่มบันทึกทำงาน
        function setupSaveButton(patientId) {
            const saveButton = document.getElementById('save-status');
            if (!saveButton) {
                console.error('ไม่พบปุ่มบันทึกใน DOM');
                return;
            }
    
            saveButton.addEventListener('click', async function () {
                const selectedStatus = document.getElementById('follow-up-status')?.value;
                const diseaseType = document.getElementById('diseaseType')?.value;
    
                if (!selectedStatus) {
                    alert('กรุณาเลือกสถานะการติดตาม');
                    return;
                }
    
                try {
                    const response = await fetch('/chiracarehospital/backend/sql/update_monitor_status.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            patient_id: patientId,
                            monitor_status: selectedStatus,
                            disease_type: diseaseType
                        })
                    });
    
                    const result = await response.json();
                    if (result.status === 'success') {
                        alert('บันทึกข้อมูลสำเร็จ');
                        window.location.href = `statustracking.html?patient_id=${patientId}`;
                    } else {
                        alert('เกิดข้อผิดพลาด: ' + (result.message || 'ไม่ทราบข้อผิดพลาด'));
                    }
                } catch (error) {
                    console.error('Error saving follow-up status:', error);
                    alert('เกิดข้อผิดพลาดในการบันทึกข้อมูล');
                }
            });
        }
    
        // แสดงสถานะปัจจุบัน
        function renderStatustrackingPage(patientData) {
            const statusElement = document.getElementById('tracking-status');
            if (statusElement) {
                const translatedStatus = translateStatus(patientData.monitor_status);
                const statusClass = getStatusClass(translatedStatus);
    
                statusElement.textContent = `สถานะการติดตาม: ${translatedStatus}`;
                statusElement.className = statusClass;
            }
        }
    
        // แปลสถานะ
        function translateStatus(status) {
            const statusMapping = {
                'ยังไม่ได้ติดตาม': 'ยังไม่ได้ติดตาม',
                'กำลังติดตาม': 'กำลังติดตาม',
                'ติดตามแล้ว': 'ติดตามแล้ว',
                'ติดตามล้มเหลว': 'ติดตามล้มเหลว'
            };
    
            return statusMapping[status] || 'สถานะไม่ทราบ';
        }
    
        // แปลงสถานะเป็น class
        function getStatusClass(status) {
            const statusClassMapping = {
                'ยังไม่ได้ติดตาม': 'ยังไม่ได้ติดตาม',
                'กำลังติดตาม': 'กำลังติดตาม',
                'ติดตามแล้ว': 'ติดตามแล้ว',
                'ติดตามล้มเหลว': 'ติดตามล้มเหลว'
            };
    
            return statusClassMapping[status] || 'สถานะไม่ทราบ';
        }
    </script>

<script>
    document.addEventListener('DOMContentLoaded', async function () {
        const patientId = getPatientIdFromURL();
        if (patientId) {
            try {
                await fetchPatientMedicalData(patientId); // ดึงข้อมูลโรคประจำตัว
                await fetchPatientInformation(patientId); // ดึงข้อมูลส่วนตัว เช่น รูปภาพ ยศ และแผนก
            } catch (error) {
                console.error('Error during initialization:', error);
                alert('เกิดข้อผิดพลาดในการโหลดข้อมูล');
            }
        } else {
            alert('ไม่พบข้อมูลผู้ป่วย');
        }
    });

    function getPatientIdFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('patient_id');
    }

    async function fetchPatientMedicalData(patientId) {
        try {
            const response = await fetch(`/chiracarehospital/backend/sql/get_patient_data.php?patient_id=${patientId}`);
            const data = await response.json();

            if (data.patient_data && data.patient_data.length > 0) {
                const patientMedicalInfo = data.patient_data[0];
                document.getElementById('diseaseType').value = patientMedicalInfo.disease_type || 'ไม่มีข้อมูลโรค';
            } else {
                document.getElementById('diseaseType').value = 'ไม่มีข้อมูลโรค';
            }
        } catch (error) {
            console.error('Error fetching patient data:', error);
            alert('เกิดข้อผิดพลาดในการดึงข้อมูลผู้ป่วย');
        }
    }

    async function fetchPatientInformation(patientId) {
        try {
            const response = await fetch(`/chiracarehospital/backend/sql/patient_information/getAll_patient_information.php?patient_id=${patientId}`);
            const data = await response.json();

            if (data.status === 'success' && data.data.length > 0) {
                const patient = data.data[0];
                displayPatientInformation(patient);
            } else {
                console.error('ไม่พบข้อมูลผู้ป่วย');
                alert('ไม่พบข้อมูลผู้ป่วย');
            }
        } catch (error) {
            console.error('Error fetching patient information:', error);
            alert('เกิดข้อผิดพลาดในการดึงข้อมูลส่วนตัว');
        }
    }

    function displayPatientInformation(patient) {
    // กรอกข้อมูลใน HTML
    document.querySelector('.full_name').textContent = patient.full_name || 'ไม่มีชื่อผู้ป่วย';
}


</script>


<script>
    // เรียกฟังก์ชัน checkAuth() เพื่อตรวจสอบ token
    checkAuth();

    // Load sidebar
    fetch('sidebar.html')
        // ใช้ fetch เพื่อดึงข้อมูล sidebar.html
        .then(response => response.text())
        // แปลงข้อมูลที่ได้รับเป็นข้อความ
        .then(data => {
            document.getElementById('sidebar-container').innerHTML = data;
            // นำข้อมูลที่ดึงมาแสดงใน sidebar-container
            loadSidebarScript();
            // เรียกฟังก์ชัน loadSidebarScript() เพื่อทำงานเพิ่มเติมกับ sidebar
        });

    // Load topbar and set the page title
    fetch('topbar.html')
        // ใช้ fetch เพื่อดึงข้อมูล topbar.html
        .then(response => response.text())
        // แปลงข้อมูลที่ได้รับเป็นข้อความ
        .then(data => {
            document.getElementById('topbar-container').innerHTML = data;
            // นำข้อมูลที่ดึงมาแสดงใน topbar-container
            document.getElementById('page-title').textContent = 'test1';
            // กำหนดชื่อเรื่องของหน้าเป็น 'หน้าหลัก'

            // Re-run user.js script after loading topbar
            const script = document.createElement('script');
            // สร้างแท็ก script ใหม่
            script.src = '../method/user.js';
            // กำหนดแหล่งที่มาของ script เป็น user.js
            document.body.appendChild(script);
            // เพิ่มแท็ก script ลงใน body ของเอกสารเพื่อทำการโหลดสคริปต์
            // ฟังก์ชันสำหรับปุ่มย้อนกลับ
            document.getElementById('backBtn').addEventListener('click', function() {
            window.location.href = 'statustracking.html';
        });
        });
</script>
</body>
</html>