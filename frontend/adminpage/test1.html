<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>โรงพยาบาลค่ายจิรประวัติ</title>
    <link rel="stylesheet" href="../../css/moreinfo2.css">
    <link rel="stylesheet" href="../../styles.css">
  <link rel="stylesheet" href="../../css/sidebar.css">
  <link rel="stylesheet" href="../../css/topbar.css">
  <link rel="stylesheet" href="../../css/logo.css">
  <link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Titillium+Web:wght@300&display=swap">
    <link href='https://unpkg.com/boxicons@2.1.1/css/boxicons.min.css' rel='stylesheet'>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../method/logout.js"></script>
    <script src="../method/user.js"></script>
    <script src="../method/loadSidebarScript.js"></script>
    <script src="../method/checkAuth.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body style="background-color:#edeff1;">
  <div id="sidebar-container"></div>
  <div id="topbar-container"></div>
  <div class="container">
    <div class="header">
      <div class="back-button">
        <button onclick="window.history.back()">
          <i class="fas fa-arrow-left"></i> ย้อนกลับ
        </button>
        <!-- <div class="more-button">
            <button onclick="window.location.href='moreinfo2.html'">
                <i class=""></i> ถัดไป
            </button>
        </div>  -->
      </div>
      <div class="header">
        <div class="patient-profile">
            <img id="profile-img" src="../../assets/images/default_profile.jpg" alt="โปรไฟล์" class="profile-img">
            <h2 id="fullName">กำลังโหลด...</h2>
        </div>
        <div class="more-button">
            <button onclick="window.location.href='moreinfo3.html'">
                <i class=""></i>แก้ไขข้อมูลทั้งหมด
            </button>
        </div>
    </div>
    
    </div>

    <!-- Follow-Up Information -->
 <!-- Follow-Up Information -->
<div class="follow-up-treatment">
    <!-- ข้อมูลการติดตาม -->
    <div class="follow-up-info">
        <h3>ข้อมูลการติดตามล่าสุด <span id="newUpdateDate">ไม่มีข้อมูล</span></h3>
        <p><strong>โรคประจำตัว:</strong> <span id="diseaseType">ไม่มีข้อมูล</span></p>
        <p><strong>สาเหตุการขาดนัด:</strong> <span id="missingAppointments">ไม่มีข้อมูล</span></p>
        <p><strong>อาการทั่วไป:</strong> <span id="generalCondition">ไม่มีข้อมูล</span></p>
        <p><strong>ค่าสัญญาณชีพ:</strong> <span id="vitalSigns">ไม่มีข้อมูล</span></p>
        <p><strong>ค่าระดับน้ำตาลในเลือด:</strong> <span id="bloodSugarLevel">ไม่มีข้อมูล</span></p>
        <p><strong>เจ้าหน้าที่ที่รับผิดชอบ:</strong> <span id="staffFollowUp">ไม่มีข้อมูล</span></p>
    </div>

    <!-- ข้อมูลการรักษา -->
    <div class="treatment-info">
        <h3>ข้อมูลการรักษาล่าสุด <span id="NewUpdateDate">ไม่มีข้อมูล</span></h3>
        <p><strong>โรคประจำตัว:</strong> <span id="treatmentDiseaseType">ไม่มีข้อมูล</span></p>
        <p><strong>วันที่นัดหมายครั้งถัดไป:</strong> <span id="treatmentDate">ไม่มีข้อมูล</span></p>
        <p><strong>เจ้าหน้าที่ที่รับผิดชอบ:</strong> <span id="staffTreatment">ไม่มีข้อมูล</span></p>
        <p><strong>หมายเหตุ:</strong> <span id="treatmentNotes">ไม่มีข้อมูล</span></p>
    </div>
</div>


  <script>
    // ฟังก์ชันเพื่อดึงค่าพารามิเตอร์จาก URL
    function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
    }

    // ฟังก์ชันสำหรับอัปเดตข้อมูลชื่อและรูปภาพ
    async function fetchAndUpdatePatientInfo(patientId) {
        const apiUrl = `/chiracarehospital/backend/sql/patient_information/getAll_patient_information.php${patientId ? `?patient_id=${patientId}` : ''}`;

        try {
            const response = await fetch(apiUrl);
            const result = await response.json();

            if (result.status === 'success' && result.data.length > 0) {
                const patient = result.data[0]; // ข้อมูลผู้ป่วยคนแรก

                // อัปเดตชื่อ
                document.getElementById('fullName').textContent = patient.full_name || 'ไม่พบข้อมูล';

                // อัปเดตรูปภาพ
                const profileImg = document.getElementById('profile-img');
                if (patient.patient_image) {
                    profileImg.src = `data:image/jpeg;base64,${patient.patient_image}`;
                } else {
                    profileImg.src = '../../assets/images/default_profile.jpg';
                }
            } else {
                console.error(result.message);
                document.getElementById('fullName').textContent = 'ไม่พบข้อมูลผู้ป่วย';
            }
        } catch (error) {
            console.error('Error fetching patient information:', error);
            document.getElementById('fullName').textContent = 'เกิดข้อผิดพลาด';
        }
    }

    // ฟังก์ชันสำหรับอัปเดตข้อมูลโรคประจำตัว
    async function fetchAndUpdateDiseaseInfo(patientId) {
        const apiUrl = `/chiracarehospital/backend/sql/get_patient_data.php${patientId ? `?patient_id=${patientId}` : ''}`;

        try {
            const response = await fetch(apiUrl);
            const result = await response.json();

            if (result.patient_data && result.patient_data.length > 0) {
                const patient = result.patient_data[0]; // ข้อมูลผู้ป่วยคนแรก
                document.getElementById('diseaseType').textContent = patient.disease_type || 'ไม่มีข้อมูล';
                document.getElementById('treatmentDiseaseType').textContent = patient.disease_type || 'ไม่มีข้อมูล';
            } else {
                console.error('ไม่พบข้อมูลผู้ป่วย');
                document.getElementById('diseaseType').textContent = 'ไม่มีข้อมูล';
                document.getElementById('treatmentDiseaseType').textContent = 'ไม่มีข้อมูล';
            }
        } catch (error) {
            console.error('เกิดข้อผิดพลาดในการดึงข้อมูล:', error);
            document.getElementById('diseaseType').textContent = 'เกิดข้อผิดพลาด';
            document.getElementById('treatmentDiseaseType').textContent = 'เกิดข้อผิดพลาด';
        }
    }

// ฟังก์ชันดึงข้อมูลจาก API สำหรับ Monitor Form
async function fetchMonitorFormData() {
    const patientId = getQueryParam('patient_id');
    const apiUrl = `/chiracarehospital/backend/sql/get_monitor_form.php${patientId ? `?patient_id=${patientId}` : ''}`; // สำหรับ Monitor Form
    try {
        const response = await fetch(apiUrl);
        const result = await response.json();

        if (result.status === 'success' && result.data.length > 0) {
            const monitorData = result.data[0]; // ข้อมูลแรกในชุดผลลัพธ์

            // อัปเดตข้อมูลใน HTML
            document.getElementById('missingAppointments').textContent = monitorData.reason_for_missed_treatment || 'ไม่มีข้อมูล';
            document.getElementById('generalCondition').textContent = monitorData.general_symptoms || 'ไม่มีข้อมูล';
            document.getElementById('vitalSigns').textContent = monitorData.vital_signs || 'ไม่มีข้อมูล';
            document.getElementById('bloodSugarLevel').textContent = monitorData.blood_sugar_level || 'ไม่มีข้อมูล';
            document.getElementById('staffFollowUp').textContent = monitorData.user_fullname || 'ไม่มีข้อมูล';

            // เพิ่มการดึงและแสดงวันที่การส่งฟอร์ม
            const submissionDate = monitorData.form_submission_date;
            if (submissionDate) {
                const formattedDate = new Date(submissionDate).toLocaleString('th-TH', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                });
                document.getElementById('newUpdateDate').textContent = formattedDate; // แสดงวันที่ใน HTML
            } else {
                document.getElementById('newUpdateDate').textContent = 'ไม่มีข้อมูล'; // ถ้าไม่มีข้อมูล
            }
        } else {
            console.error('ไม่พบข้อมูลในฐานข้อมูล');
            updateNoData('monitor');
        }
    } catch (error) {
        console.error('เกิดข้อผิดพลาดในการดึงข้อมูล:', error);
        updateNoData('monitor');
    }
}


    // ฟังก์ชันดึงข้อมูลจาก API สำหรับ Treatment Form
    async function fetchTreatmentData() {
    const patientId = getQueryParam('patient_id');
    const apiUrl = `/chiracarehospital/backend/sql/get_treatment_form.php${patientId ? `?patient_id=${patientId}` : ''}`; // สำหรับ Treatment Form
    try {
        const response = await fetch(apiUrl);
        const result = await response.json();

        if (result.status === 'success' && result.data.length > 0) {
            const treatmentData = result.data[0]; // ข้อมูลแรกในชุดผลลัพธ์

            // อัปเดตข้อมูลใน HTML
            document.getElementById('treatmentDate').textContent = treatmentData.next_appointment_date || 'ไม่มีข้อมูล';
            document.getElementById('staffTreatment').textContent = treatmentData.user_fullname || 'ไม่มีข้อมูล';
            document.getElementById('treatmentNotes').textContent = treatmentData.notes || 'ไม่มีข้อมูล';

            // ดึงและแสดงวันที่การอัปเดต
            const newUpdateDate = treatmentData.newupdate; // วันที่การอัปเดต
            if (newUpdateDate) {
                const formattedDate = new Date(newUpdateDate).toLocaleString('th-TH', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                });
                document.getElementById('NewUpdateDate').textContent = formattedDate; // แสดงวันที่
            } else {
                document.getElementById('NewUpdateDate').textContent = 'ไม่มีข้อมูล'; // ถ้าไม่มีข้อมูล
            }
        } else {
            console.error(result.message);
            updateNoData('treatment');
        }
    } catch (error) {
        console.error('เกิดข้อผิดพลาดในการดึงข้อมูล:', error);
        updateNoData('treatment');
    }
}


    // ฟังก์ชันอัปเดตเมื่อไม่มีข้อมูล
    function updateNoData(formType) {
        if (formType === 'monitor') {
            document.getElementById('missingAppointments').textContent = 'ไม่มีข้อมูล';
            document.getElementById('generalCondition').textContent = 'ไม่มีข้อมูล';
            document.getElementById('vitalSigns').textContent = 'ไม่มีข้อมูล';
            document.getElementById('bloodSugarLevel').textContent = 'ไม่มีข้อมูล';
            document.getElementById('staffFollowUp').textContent = 'ไม่มีข้อมูล';
        } else if (formType === 'treatment') {
            document.getElementById('treatmentDate').textContent = 'ไม่มีข้อมูล';
            document.getElementById('staffTreatment').textContent = 'ไม่มีข้อมูล';
            document.getElementById('treatmentNotes').textContent = 'ไม่มีข้อมูล';
        }
    }

    // ฟังก์ชันทั้งหมดจะถูกเรียกใช้เมื่อหน้าโหลด
    async function initializePage() {
        const patientId = getQueryParam('patient_id');
        
        // เรียกฟังก์ชันเพื่อดึงข้อมูลผู้ป่วย
        await fetchAndUpdatePatientInfo(patientId);
        await fetchAndUpdateDiseaseInfo(patientId);

        // เรียกฟังก์ชันเพื่อดึงข้อมูล Monitor และ Treatment Form
        await fetchMonitorFormData();
        await fetchTreatmentData();
    }

    // เรียกใช้ฟังก์ชันเมื่อโหลดหน้า
    initializePage();
</script>

  <script>
    // เรียกฟังก์ชัน checkAuth() เพื่อตรวจสอบ token
    checkAuth();
  
    // Load sidebar
    fetch('sidebar.html')
        .then(response => response.text())
        .then(data => {
            document.getElementById('sidebar-container').innerHTML = data;
            loadSidebarScript();
        });
  
    // Load topbar and set the page title
    fetch('topbar.html')
        .then(response => response.text())
        .then(data => {
            document.getElementById('topbar-container').innerHTML = data;
            document.getElementById('page-title').textContent = 'สถานะการติดตามและการรักษาของผู้ป่วย';
  
            // Re-run user.js script after loading topbar
            const script = document.createElement('script');
            script.src = '../method/user.js';
            document.body.appendChild(script);
        });
  </script>
</body>
</html>